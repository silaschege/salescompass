{% extends 'dashboard/base.html' %}
{% load humanize %}

{% block title %}Dashboard - SalesCompass CRM{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .stats-card h3 {
        font-size: 14px;
        color: #666;
        margin: 0 0 10px 0;
        font-weight: 500;
    }

    .stats-card .value {
        font-size: 32px;
        font-weight: 700;
        color: #333;
        margin: 0;
    }

    .stats-card .change {
        font-size: 12px;
        margin-top: 8px;
    }

    .change.positive {
        color: #10b981;
    }

    .change.negative {
        color: #ef4444;
    }

    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 20px 0;
        color: #333;
    }

    .activity-feed {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .activity-item {
        padding: 12px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }

    .activity-icon.lead {
        background: #dbeafe;
        color: #3b82f6;
    }

    .activity-icon.opportunity {
        background: #d1fae5;
        color: #10b981;
    }

    .activity-icon.case {
        background: #fee2e2;
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1>Dashboard</h1>
            <p class="text-muted">Welcome back, {{ request.user.first_name|default:request.user.email }}</p>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row">
        <div class="col-md-3">
            <div class="stats-card">
                <h3>Total Leads</h3>
                <p class="value">{{ total_leads|intcomma }}</p>
                <p class="change positive">+{{ leads_change }}% from last month</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3>Open Opportunities</h3>
                <p class="value">{{ total_opportunities|intcomma }}</p>
                <p class="change positive">{{ opportunities_value|intcomma }} value</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3>Open Cases</h3>
                <p class="value">{{ total_cases|intcomma }}</p>
                <p class="change {% if cases_change < 0 %}positive{% else %}negative{% endif %}">
                    {% if cases_change > 0 %}+{% endif %}{{ cases_change }}% from last month
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3>Revenue (MTD)</h3>
                <p class="value">${{ total_revenue|intcomma }}</p>
                <p class="change {% if revenue_change > 0 %}positive{% else %}negative{% endif %}">
                    {% if revenue_change > 0 %}+{% endif %}{{ revenue_change }}% from last month
                </p>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- Revenue Chart -->
        <div class="col-md-8">
            <div class="chart-container">
                <h2 class="chart-title">Revenue Trend</h2>
                <canvas id="revenueChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Pipeline Snapshot -->
        <div class="col-md-4">
            <div class="chart-container">
                <h2 class="chart-title">Pipeline by Stage</h2>
                <canvas id="pipelineChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Activity Feed -->
    <div class="row">
        <div class="col-md-12">
            <div class="activity-feed">
                <h2 class="chart-title">Recent Activity</h2>
                {% if recent_activities %}
                {% for activity in recent_activities %}
                <div class="activity-item">
                    <div class="d-flex align-items-center">
                        <div class="activity-icon {{ activity.type }}">
                            {% if activity.type == 'lead' %}
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path
                                    d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z" />
                            </svg>
                            {% elif activity.type == 'opportunity' %}
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path
                                    d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z" />
                            </svg>
                            {% elif activity.type == 'case' %}
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path
                                    d="M4.285 9.567a.5.5 0 0 1 .683.183A3.498 3.498 0 0 0 8 11.5a3.498 3.498 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.498 4.498 0 0 1 8 12.5a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z" />
                            </svg>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <p class="mb-0"><strong>{{ activity.title }}</strong></p>
                            <p class="text-muted mb-0 small">{{ activity.description }}</p>
                        </div>
                        <div class="text-muted small">
                            {{ activity.timestamp|timesince }} ago
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">No recent activity</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Revenue Chart (Line Chart)
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: {{ revenue_labels| safe }},
    datasets: [{
        label: 'Revenue',
        data: {{ revenue_data| safe }},
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                    ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
    });

    // Pipeline Chart (Horizontal Bar Chart)
    const pipelineCtx = document.getElementById('pipelineChart').getContext('2d');
    const pipelineChart = new Chart(pipelineCtx, {
        type: 'bar',
        data: {
            labels: {{ pipeline_labels| safe }},
    datasets: [{
        label: 'Opportunities',
        data: {{ pipeline_data| safe }},
        backgroundColor: [
        '#3b82f6',
        '#8b5cf6',
        '#ec4899',
        '#10b981',
        '#f59e0b'
    ]
            }]
        },
    options: {
        indexAxis: 'y',
            responsive: true,
                maintainAspectRatio: false,
                    plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
    });
</script>
{% endblock %}