{% extends "dashboard/base.html" %}

{% block title %}Data Explorer | SalesCompass{% endblock %}

{% block extra_css %}
<style>
    .module-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
        cursor: pointer;
    }
    
    .module-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-color: #007bff;
    }
    
    .module-card.selected {
        border-color: #007bff;
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .field-selector {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .visualization-container {
        min-height: 400px;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .query-result-table {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .filter-badge {
        background-color: #e9ecef;
        border-radius: 1rem;
        padding: 0.25rem 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        display: inline-flex;
        align-items: center;
    }
    
    .filter-badge .remove-filter {
        margin-left: 0.5rem;
        cursor: pointer;
        color: #6c757d;
    }
    
    .visualization-placeholder {
        text-align: center;
        color: #6c757d;
    }
    
    .visualization-placeholder i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .saved-query-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .saved-query-item:hover {
        background-color: #f8f9fa;
    }
    
    .query-builder-section {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .field-chip {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 1rem;
        padding: 0.25rem 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .field-chip .remove-field {
        margin-left: 0.5rem;
        cursor: pointer;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h1 class="h3 mb-0">Data Explorer</h1>
            <p class="text-muted mb-0">Explore and visualize your CRM data</p>
        </div>
        <div>
            <button class="btn btn-primary" id="saveQueryBtn">
                <i class="bi bi-save"></i> Save Query
            </button>
            <button class="btn btn-outline-secondary" id="exportBtn">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- Left Panel -->
        <div class="col-md-3">
            <!-- Saved Queries -->
            <div class="card dashboard-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Saved Queries</h5>
                    <button class="btn btn-sm btn-outline-primary" id="newQueryBtn">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
                <div class="list-group list-group-flush" id="savedQueriesList">
                    <a href="#" class="list-group-item list-group-item-action saved-query-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Top Leads</h6>
                            <small>Leads</small>
                        </div>
                        <small class="text-muted">Leads with highest potential</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action saved-query-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Won Opportunities</h6>
                            <small>Opportunities</small>
                        </div>
                        <small class="text-muted">Recently closed opportunities</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action saved-query-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Active Accounts</h6>
                            <small>Accounts</small>
                        </div>
                        <small class="text-muted">High-value active accounts</small>
                    </a>
                </div>
            </div>
            
            <!-- Data Modules -->
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5>Data Modules</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action module-selector" data-module="leads">
                        <i class="bi bi-person-plus"></i> Leads
                        <span class="float-end text-muted">{{ leads_count|default:0 }}</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action module-selector" data-module="opportunities">
                        <i class="bi bi-briefcase"></i> Opportunities
                        <span class="float-end text-muted">{{ opportunities_count|default:0 }}</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action module-selector" data-module="accounts">
                        <i class="bi bi-building"></i> Accounts
                        <span class="float-end text-muted">{{ accounts_count|default:0 }}</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action module-selector" data-module="cases">
                        <i class="bi bi-inbox"></i> Cases
                        <span class="float-end text-muted">{{ cases_count|default:0 }}</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action module-selector" data-module="tasks">
                        <i class="bi bi-check2-square"></i> Tasks
                        <span class="float-end text-muted">{{ tasks_count|default:0 }}</span>
                    </a>
                </div>
            </div>
            
            <!-- Fields Panel -->
            <div class="card dashboard-card mt-4">
                <div class="card-header">
                    <h5>Fields</h5>
                </div>
                <div class="card-body field-selector">
                    <div id="fieldsContainer">
                        <p class="text-muted">Select a module to view available fields</p>
                    </div>
                </div>
            </div>
            
            <!-- Filters Panel -->
            <div class="card dashboard-card mt-4">
                <div class="card-header">
                    <h5>Filters</h5>
                </div>
                <div class="card-body">
                    <div id="appliedFilters" class="mb-3">
                        <p class="text-muted mb-2">Applied filters:</p>
                        <div id="filterBadgesContainer">
                            <!-- Filter badges will appear here -->
                        </div>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label>Date Range</label>
                        <select class="form-control" id="dateRangeFilter">
                            <option value="">Select range</option>
                            <option>Last 7 Days</option>
                            <option selected>Last 30 Days</option>
                            <option>Last 90 Days</option>
                            <option>Last Year</option>
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label>Field</label>
                        <select class="form-control" id="filterField">
                            <option value="">Select a field</option>
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label>Condition</label>
                        <select class="form-control" id="filterCondition">
                            <option value="">Select condition</option>
                            <option value="equals">Equals</option>
                            <option value="not_equals">Not Equals</option>
                            <option value="contains">Contains</option>
                            <option value="greater_than">Greater Than</option>
                            <option value="less_than">Less Than</option>
                            <option value="starts_with">Starts With</option>
                            <option value="ends_with">Ends With</option>
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label>Value</label>
                        <input type="text" class="form-control" id="filterValue" placeholder="Enter value">
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="addFilterBtn">
                        <i class="bi bi-plus"></i> Add Filter
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-md-9">
            <div class="card dashboard-card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="explorerTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="visual-tab" data-bs-toggle="tab" href="#visual" role="tab">
                                <i class="bi bi-eye"></i> Visual Query
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="sql-tab" data-bs-toggle="tab" href="#sql" role="tab">
                                <i class="bi bi-code-slash"></i> SQL Editor
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Visual Query Builder -->
                        <div class="tab-pane fade show active" id="visual" role="tabpanel">
                            <div class="query-builder-section">
                                <h5>Query Builder</h5>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label>Select Data Module</label>
                                        <select class="form-control" id="moduleSelect">
                                            <option value="">Choose a module</option>
                                            <option value="leads">Leads</option>
                                            <option value="opportunities">Opportunities</option>
                                            <option value="accounts">Accounts</option>
                                            <option value="cases">Cases</option>
                                            <option value="tasks">Tasks</option>
                                        </select>
                                    </div>
{% comment %}                                     
                                    <div class="col-md-8">
                                        <label>Selected Fields</label>
                                        <div class="border rounded p-2 mb-2" id="selectedFieldsContainer">
                                            <p class="text-muted mb-0">No fields selected</p>
                                            
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-secondary" id="clearFieldsBtn">Clear All</button>
                                        </div>
                                    </div> {% endcomment %}

                                    <div class="col-md-8">
                                        <label>Selected Fields</label>
                                        <div>
                                        <select class="form-control" id="selectedFieldsContainer">
                                            <option value="">None</option>
                                        </select>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-secondary" id="clearFieldsBtn">Clear All</button>
                                        </div>
                                   
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label>Group By</label>
                                        <select class="form-control" id="groupBySelect">
                                            <option value="">None</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label>Sort By</label>
                                        <select class="form-control" id="sortSelect">
                                            <option value="">None</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label>Sort Direction</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="sortDirection" id="sortAsc" value="asc" checked>
                                            <label class="form-check-label" for="sortAsc">Ascending</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="sortDirection" id="sortDesc" value="desc">
                                            <label class="form-check-label" for="sortDesc">Descending</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="query-builder-section">
                                <h5>Visualization</h5>
                                <div class="form-group mb-3">
                                    <label>Chart Type</label>
                                    <div class="row">
                                        <div class="col-md-2 text-center">
                                            <button class="btn btn-outline-secondary visualization-type active" data-type="table">
                                                <i class="bi bi-table"></i><br>Table
                                            </button>
                                        </div>
                                        <div class="col-md-2 text-center">
                                            <button class="btn btn-outline-secondary visualization-type" data-type="bar">
                                                <i class="bi bi-bar-chart"></i><br>Bar
                                            </button>
                                        </div>
                                        <div class="col-md-2 text-center">
                                            <button class="btn btn-outline-secondary visualization-type" data-type="line">
                                                <i class="bi bi-graph-up"></i><br>Line
                                            </button>
                                        </div>
                                        <div class="col-md-2 text-center">
                                            <button class="btn btn-outline-secondary visualization-type" data-type="pie">
                                                <i class="bi bi-pie-chart"></i><br>Pie
                                            </button>
                                        </div>
                                        <div class="col-md-2 text-center">
                                            <button class="btn btn-outline-secondary visualization-type" data-type="funnel">
                                                <i class="bi bi-funnel"></i><br>Funnel
                                            </button>
                                        </div>
                                        <div class="col-md-2 text-center">
                                            <button class="btn btn-outline-secondary visualization-type" data-type="area">
                                                <i class="bi bi-graph-down"></i><br>Area
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button class="btn btn-success" id="runQueryBtn">
                                        <i class="bi bi-play"></i> Run Query
                                    </button>
                                    <button class="btn btn-outline-secondary" id="previewQueryBtn">
                                        <i class="bi bi-eye"></i> Preview SQL
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-outline-primary" id="saveAsReportBtn">
                                        <i class="bi bi-file-earmark-bar-graph"></i> Save as Report
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SQL Editor -->
                        <div class="tab-pane fade" id="sql" role="tabpanel">
                            <div class="form-group mb-3">
                                <label>SQL Query</label>
                                <textarea class="form-control" rows="12" id="sqlEditor" placeholder="Enter your SQL query here...">SELECT * FROM {{ selected_module|default:'leads' }} LIMIT 100;</textarea>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button class="btn btn-success" id="runSqlBtn">
                                        <i class="bi bi-play"></i> Execute
                                    </button>
                                    <button class="btn btn-outline-secondary" id="formatSqlBtn">
                                        <i class="bi bi-braces"></i> Format
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-outline-primary" id="saveSqlAsReportBtn">
                                        <i class="bi bi-file-earmark-bar-graph"></i> Save as Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="card dashboard-card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Query Results</h5>
                    <div>
                        <span class="badge bg-secondary" id="resultCount">0 records</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="refreshResultsBtn">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="visualization-container" id="visualizationContainer">
                        <div class="visualization-placeholder">
                            <i class="bi bi-search"></i>
                            <p>Run a query to see results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview SQL Modal -->
<div class="modal fade" id="previewSqlModal" tabindex="-1" aria-labelledby="previewSqlModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewSqlModalLabel">Generated SQL Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="previewSqlContent" class="bg-light p-3"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copySqlBtn">Copy to Clipboard</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Query Modal -->
<div class="modal fade" id="saveQueryModal" tabindex="-1" aria-labelledby="saveQueryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveQueryModalLabel">Save Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveQueryForm">
                    <div class="mb-3">
                        <label for="queryName" class="form-label">Query Name</label>
                        <input type="text" class="form-control" id="queryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="queryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="queryDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="queryTags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="queryTags" placeholder="Enter tags separated by commas">
                    </div>
                    <div class="mb-3">
                        <label for="queryModule" class="form-label">Module</label>
                        <select class="form-control" id="queryModule">
                            <option value="leads">Leads</option>
                            <option value="opportunities">Opportunities</option>
                            <option value="accounts">Accounts</option>
                            <option value="cases">Cases</option>
                            <option value="tasks">Tasks</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveQueryConfirmBtn">Save Query</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    let selectedModule = '';
    let appliedFilters = [];
    let selectedFields = [];
    let moduleFields = {
        'leads': [
            {name: 'id', label: 'ID', type: 'number'},
            {name: 'first_name', label: 'First Name', type: 'string'},
            {name: 'last_name', label: 'Last Name', type: 'string'},
            {name: 'email', label: 'Email', type: 'string'},
            {name: 'phone', label: 'Phone', type: 'string'},
            {name: 'company', label: 'Company', type: 'string'},
            {name: 'source', label: 'Source', type: 'string'},
            {name: 'status', label: 'Status', type: 'string'},
            {name: 'lead_created_at', label: 'Created At', type: 'datetime'},
            {name: 'lead_updated_at', label: 'Updated At', type: 'datetime'}
        ],
        'opportunities': [
            {name: 'id', label: 'ID', type: 'number'},
            {name: 'name', label: 'Opportunity Name', type: 'string'},
            {name: 'account_id', label: 'Account', type: 'number'},
            {name: 'amount', label: 'Amount', type: 'decimal'},
            {name: 'stage', label: 'Stage', type: 'string'},
            {name: 'probability', label: 'Probability', type: 'number'},
            {name: 'close_date', label: 'Close Date', type: 'date'},
            {name: 'opportunity_created_at', label: 'Created At', type: 'datetime'},
            {name: 'opportunity_updated_at', label: 'Updated At', type: 'datetime'}
        ],
        'accounts': [
            {name: 'id', label: 'ID', type: 'number'},
            {name: 'account_name', label: 'Account Name', type: 'string'},
            {name: 'account_type', label: 'Type', type: 'string'},
            {name: 'industry', label: 'Industry', type: 'string'},
            {name: 'website', label: 'Website', type: 'string'},
            {name: 'phone', label: 'Phone', type: 'string'},
            {name: 'annual_revenue', label: 'Annual Revenue', type: 'decimal'},
            {name: 'account_created_at', label: 'Created At', type: 'datetime'},
            {name: 'account_updated_at', label: 'Updated At', type: 'datetime'}
        ],
        'cases': [
            {name: 'id', label: 'ID', type: 'number'},
            {name: 'subject', label: 'Subject', type: 'string'},
            {name: 'description', label: 'Description', type: 'text'},
            {name: 'status', label: 'Status', type: 'string'},
            {name: 'priority', label: 'Priority', type: 'string'},
            {name: 'account_id', label: 'Account', type: 'number'},
            {name: 'case_created_at', label: 'Created At', type: 'datetime'},
            {name: 'case_updated_at', label: 'Updated At', type: 'datetime'}
        ],
        'tasks': [
            {name: 'id', label: 'ID', type: 'number'},
            {name: 'subject', label: 'Subject', type: 'string'},
            {name: 'description', label: 'Description', type: 'text'},
            {name: 'status', label: 'Status', type: 'string'},
            {name: 'priority', label: 'Priority', type: 'string'},
            {name: 'due_date', label: 'Due Date', type: 'date'},
            {name: 'assigned_to', label: 'Assigned To', type: 'number'},
            {name: 'task_created_at', label: 'Created At', type: 'datetime'},
            {name: 'task_updated_at', label: 'Updated At', type: 'datetime'}
        ]
    };
    
    // Tab switching
    const triggerTabList = [].slice.call(document.querySelectorAll('#explorerTabs a'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
        });
    });
    
    // Module selection
    document.querySelectorAll('.module-selector').forEach(card => {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            const module = this.getAttribute('data-module');
            selectModule(module);
        });
    });
    
    document.getElementById('moduleSelect').addEventListener('change', function() {
        const module = this.value;
        selectModule(module);
    });
    
    function selectModule(module) {
        if (!module) return;
        
        selectedModule = module;
        
        // Update UI
        document.querySelectorAll('.module-selector').forEach(card => {
            card.classList.remove('selected');
            if (card.getAttribute('data-module') === module) {
                card.classList.add('selected');
            }
        });
        
        document.getElementById('moduleSelect').value = module;
        document.getElementById('queryModule').value = module;
        
        // Update fields
        updateFields(module);
        
        // Update SQL editor
        document.getElementById('sqlEditor').value = `SELECT * FROM ${module} LIMIT 100;`;
    }
    
    function updateFields(module) {
        const fields = moduleFields[module] || [];
        const fieldsContainer = document.getElementById('fieldsContainer');
        const groupBySelect = document.getElementById('groupBySelect');
        const sortSelect = document.getElementById('sortSelect');
        const filterFieldSelect = document.getElementById('filterField');
        
        // Clear existing options
        groupBySelect.innerHTML = '<option value="">None</option>';
        sortSelect.innerHTML = '<option value="">None</option>';
        filterFieldSelect.innerHTML = '<option value="">Select a field</option>';
        
        if (fields.length === 0) {
            fieldsContainer.innerHTML = '<p class="text-muted">No fields available for this module</p>';
            return;
        }
        
        // Update fields container for the left panel
        let fieldsHtml = '<div class="form-check">';
        fields.forEach(field => {
            fieldsHtml += `
                <div class="form-check mb-2">
                    <input class="form-check-input field-checkbox" type="checkbox" value="${field.name}" id="field_${field.name}">
                    <label class="form-check-label" for="field_${field.name}">
                        ${field.label} <span class="text-muted">(${field.type})</span>
                    </label>
                </div>
            `;
        });
        fieldsHtml += '</div>';
        fieldsContainer.innerHTML = fieldsHtml;
        
        // Add event listeners to checkboxes
        document.querySelectorAll('.field-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const fieldName = this.value;
                const fieldLabel = this.nextElementSibling.textContent.split(' (')[0];
                
                if (this.checked) {
                    // Add to selected fields
                    selectedFields.push({name: fieldName, label: fieldLabel});
                } else {
                    // Remove from selected fields
                    selectedFields = selectedFields.filter(f => f.name !== fieldName);
                }
                
                updateSelectedFieldsDisplay();
            });
        });
        
        // Update group by and sort selects
        fields.forEach(field => {
            const groupOption = document.createElement('option');
            groupOption.value = field.name;
            groupOption.textContent = field.label;
            groupBySelect.appendChild(groupOption);
            
            const sortOption = document.createElement('option');
            sortOption.value = field.name;
            sortOption.textContent = field.label;
            sortSelect.appendChild(sortOption);
        });
        
        // Update filter field select
        fields.forEach(field => {
            const filterOption = document.createElement('option');
            filterOption.value = field.name;
            filterOption.textContent = field.label;
            filterFieldSelect.appendChild(filterOption);
        });
    }
    
    function updateSelectedFieldsDisplay() {
        const container = document.getElementById('selectedFieldsContainer');
        
        if (selectedFields.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No fields selected</p>';
            return;
        }
        
        let html = '';
        selectedFields.forEach(field => {
            html += `
                <div class="field-chip">
                    ${field.label}
                    <span class="remove-field" data-field="${field.name}">&times;</span>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-field').forEach(button => {
            button.addEventListener('click', function() {
                const fieldName = this.getAttribute('data-field');
                
                // Remove from selected fields array
                selectedFields = selectedFields.filter(f => f.name !== fieldName);
                
                // Uncheck the checkbox
                const checkbox = document.querySelector(`.field-checkbox[value="${fieldName}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                }
                
                // Update display
                updateSelectedFieldsDisplay();
            });
        });
    }
    
    // Clear all fields
    document.getElementById('clearFieldsBtn').addEventListener('click', function() {
        // Clear selected fields array
        selectedFields = [];
        
        // Uncheck all checkboxes
        document.querySelectorAll('.field-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Update display
        updateSelectedFieldsDisplay();
    });
    
    // Visualization type selection
    document.querySelectorAll('.visualization-type').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.visualization-type').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-secondary');
            });
            this.classList.remove('btn-outline-secondary');
            this.classList.add('active', 'btn-primary');
        });
    });
    
    // Add filter
    document.getElementById('addFilterBtn').addEventListener('click', function() {
        const field = document.getElementById('filterField').value;
        const condition = document.getElementById('filterCondition').value;
        const value = document.getElementById('filterValue').value;
        
        if (!field || !condition || !value) {
            alert('Please fill in all filter fields');
            return;
        }
        
        // Add to applied filters
        const filter = {
            field: field,
            condition: condition,
            value: value
        };
        appliedFilters.push(filter);
        
        // Update UI
        updateFilterBadges();
        
        // Clear inputs
        document.getElementById('filterField').value = '';
        document.getElementById('filterCondition').value = '';
        document.getElementById('filterValue').value = '';
    });
    
    function updateFilterBadges() {
        const container = document.getElementById('filterBadgesContainer');
        container.innerHTML = '';
        
        if (appliedFilters.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No filters applied</p>';
            return;
        }
        
        appliedFilters.forEach((filter, index) => {
            const badge = document.createElement('div');
            badge.className = 'filter-badge';
            badge.innerHTML = `
                ${filter.field} ${getConditionLabel(filter.condition)} ${filter.value}
                <span class="remove-filter" data-index="${index}">&times;</span>
            `;
            container.appendChild(badge);
        });
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-filter').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                appliedFilters.splice(index, 1);
                updateFilterBadges();
            });
        });
    }
    
    function getConditionLabel(condition) {
        const labels = {
            'equals': '=',
            'not_equals': '!=',
            'contains': 'contains',
            'greater_than': '>',
            'less_than': '<',
            'starts_with': 'starts with',
            'ends_with': 'ends with'
        };
        return labels[condition] || condition;
    }
    
    // Run query button
    document.getElementById('runQueryBtn').addEventListener('click', function() {
        if (!selectedModule) {
            alert('Please select a data module');
            return;
        }
        
        if (selectedFields.length === 0) {
            alert('Please select at least one field to display');
            return;
        }
        
        // Get visualization type
        const visualizationType = document.querySelector('.visualization-type.active').getAttribute('data-type');
        
        // Simulate query execution
        executeQuery(selectedModule, selectedFields, visualizationType);
    });
    
    function executeQuery(module, fields, visualizationType) {
        // Show loading state
        const container = document.getElementById('visualizationContainer');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Executing query...</p>
            </div>
        `;
        
        // Simulate API call delay
        setTimeout(() => {
            // Generate sample data based on module
            let data = [];
            let recordCount = Math.floor(Math.random() * 100) + 20;
            
            for (let i = 0; i < recordCount; i++) {
                let record = {};
                fields.forEach(field => {
                    switch(field.name) {
                        case 'id':
                            record[field.name] = i + 1;
                            break;
                        case 'first_name':
                            record[field.name] = ['John', 'Jane', 'Bob', 'Alice', 'Charlie'][Math.floor(Math.random() * 5)];
                            break;
                        case 'last_name':
                            record[field.name] = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones'][Math.floor(Math.random() * 5)];
                            break;
                        case 'email':
                            record[field.name] = `user${i}@example.com`;
                            break;
                        case 'amount':
                            record[field.name] = Math.floor(Math.random() * 10000) + 1000;
                            break;
                        case 'status':
                            record[field.name] = ['New', 'In Progress', 'Closed'][Math.floor(Math.random() * 3)];
                            break;
                        case 'stage':
                            record[field.name] = ['Prospecting', 'Qualification', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'][Math.floor(Math.random() * 6)];
                            break;
                        default:
                            record[field.name] = `${field.name}_${i}`;
                    }
                });
                data.push(record);
            }
            
            // Render visualization
            renderVisualization(data, visualizationType);
            
            // Update record count
            document.getElementById('resultCount').textContent = `${recordCount} records`;
        }, 1000);
    }
    
    function renderVisualization(data, type) {
        const container = document.getElementById('visualizationContainer');
        
        if (data.length === 0) {
            container.innerHTML = `
                <div class="visualization-placeholder">
                    <i class="bi bi-database-x"></i>
                    <p>No data found for your query</p>
                </div>
            `;
            return;
        }
        
        switch(type) {
            case 'table':
                renderTable(data, container);
                break;
            case 'bar':
                renderBarChart(data, container);
                break;
            case 'line':
                renderLineChart(data, container);
                break;
            case 'pie':
                renderPieChart(data, container);
                break;
            case 'funnel':
                renderFunnelChart(data, container);
                break;
            case 'area':
                renderAreaChart(data, container);
                break;
            default:
                renderTable(data, container);
        }
    }
    
    function renderTable(data, container) {
        if (data.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">No data to display</p>';
            return;
        }
        
        // Get field names from the first record
        const keys = Object.keys(data[0]);
        let html = `
            <div class="query-result-table">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            ${keys.map(key => `<th>${key}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.forEach(row => {
            html += '<tr>';
            keys.forEach(key => {
                html += `<td>${row[key]}</td>`;
            });
            html += '</tr>';
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function renderBarChart(data, container) {
        container.innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Bar Chart Visualization</h4>
                <p class="text-muted">Bar chart would be rendered here with ${data.length} data points</p>
                <div class="bg-light p-3 mt-3 rounded">
                    <p class="mb-1"><strong>Sample Data:</strong></p>
                    <p class="mb-0">X-axis: ${Object.keys(data[0])[0]}</p>
                    <p class="mb-0">Y-axis: ${Object.keys(data[0])[1] || 'Count'}</p>
                </div>
            </div>
        `;
    }
    
    function renderLineChart(data, container) {
        container.innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-graph-up" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Line Chart Visualization</h4>
                <p class="text-muted">Line chart would be rendered here with ${data.length} data points</p>
                <div class="bg-light p-3 mt-3 rounded">
                    <p class="mb-1"><strong>Sample Data:</strong></p>
                    <p class="mb-0">X-axis: ${Object.keys(data[0])[0]}</p>
                    <p class="mb-0">Y-axis: ${Object.keys(data[0])[1] || 'Value'}</p>
                </div>
            </div>
        `;
    }
    
    function renderPieChart(data, container) {
        container.innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-pie-chart" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Pie Chart Visualization</h4>
                <p class="text-muted">Pie chart would be rendered here with ${data.length} segments</p>
                <div class="bg-light p-3 mt-3 rounded">
                    <p class="mb-1"><strong>Sample Data:</strong></p>
                    <p class="mb-0">Categories: ${Object.keys(data[0])[0]}</p>
                    <p class="mb-0">Values: ${Object.keys(data[0])[1] || 'Count'}</p>
                </div>
            </div>
        `;
    }
    
    function renderFunnelChart(data, container) {
        container.innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-funnel" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Funnel Visualization</h4>
                <p class="text-muted">Funnel chart would be rendered here with ${data.length} stages</p>
                <div class="bg-light p-3 mt-3 rounded">
                    <p class="mb-1"><strong>Sample Data:</strong></p>
                    <p class="mb-0">Stages: ${Object.keys(data[0])[0]}</p>
                    <p class="mb-0">Values: ${Object.keys(data[0])[1] || 'Count'}</p>
                </div>
            </div>
        `;
    }
    
    function renderAreaChart(data, container) {
        container.innerHTML = `
            <div class="text-center p-5">
                <i class="bi bi-graph-down" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Area Chart Visualization</h4>
                <p class="text-muted">Area chart would be rendered here with ${data.length} data points</p>
                <div class="bg-light p-3 mt-3 rounded">
                    <p class="mb-1"><strong>Sample Data:</strong></p>
                    <p class="mb-0">X-axis: ${Object.keys(data[0])[0]}</p>
                    <p class="mb-0">Y-axis: ${Object.keys(data[0])[1] || 'Value'}</p>
                </div>
            </div>
        `;
    }
    
    // Run SQL button
    document.getElementById('runSqlBtn').addEventListener('click', function() {
        const sql = document.getElementById('sqlEditor').value.trim();
        if (!sql) {
            alert('Please enter a SQL query');
            return;
        }
        
        // Show loading state
        const container = document.getElementById('visualizationContainer');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Executing SQL query...</p>
            </div>
        `;
        
        // Simulate SQL execution
        setTimeout(() => {
            // Generate sample data
            const data = [];
            const recordCount = Math.floor(Math.random() * 50) + 10;
            
            for (let i = 0; i < recordCount; i++) {
                data.push({
                    id: i + 1,
                    name: `Record ${i + 1}`,
                    value: Math.floor(Math.random() * 1000),
                    date: new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                });
            }
            
            // Render as table
            renderVisualization(data, 'table');
            
            // Update record count
            document.getElementById('resultCount').textContent = `${recordCount} records`;
        }, 1500);
    });
    
    // Preview SQL button
    document.getElementById('previewQueryBtn').addEventListener('click', function() {
        if (!selectedModule) {
            alert('Please select a data module first');
            return;
        }
        
        if (selectedFields.length === 0) {
            alert('Please select at least one field');
            return;
        }
        
        // Generate SQL
        let sql = `SELECT ${selectedFields.map(f => f.name).join(', ')}\nFROM ${selectedModule}`;
        
        if (appliedFilters.length > 0) {
            sql += '\nWHERE ';
            const conditions = appliedFilters.map(filter => {
                let value = filter.value;
                if (typeof value === 'string') {
                    value = `'${value}'`;
                }
                return `${filter.field} ${getSqlOperator(filter.condition)} ${value}`;
            });
            sql += conditions.join(' AND ');
        }
        
        // Add GROUP BY
        const groupBy = document.getElementById('groupBySelect').value;
        if (groupBy) {
            sql += `\nGROUP BY ${groupBy}`;
        }
        
        // Add ORDER BY
        const sortBy = document.getElementById('sortSelect').value;
        if (sortBy) {
            const sortDir = document.querySelector('input[name="sortDirection"]:checked').value;
            sql += `\nORDER BY ${sortBy} ${sortDir.toUpperCase()}`;
        }
        
        // Add limit
        sql += '\nLIMIT 1000';
        
        // Show in modal
        document.getElementById('previewSqlContent').textContent = sql;
        const modal = new bootstrap.Modal(document.getElementById('previewSqlModal'));
        modal.show();
    });
    
    function getSqlOperator(condition) {
        const operators = {
            'equals': '=',
            'not_equals': '!=',
            'contains': 'LIKE',
            'greater_than': '>',
            'less_than': '<',
            'starts_with': 'LIKE',
            'ends_with': 'LIKE'
        };
        return operators[condition] || '=';
    }
    
    // Copy SQL button
    document.getElementById('copySqlBtn').addEventListener('click', function() {
        const sql = document.getElementById('previewSqlContent').textContent;
        navigator.clipboard.writeText(sql).then(() => {
            const originalText = this.textContent;
            this.innerHTML = '<i class="bi bi-check"></i> Copied!';
            setTimeout(() => {
                this.textContent = originalText;
            }, 2000);
        });
    });
    
    // Format SQL button
    document.getElementById('formatSqlBtn').addEventListener('click', function() {
        const sql = document.getElementById('sqlEditor').value;
        // In a real implementation, this would format the SQL
        alert('SQL formatting would be applied here');
    });
    
    // Save query button
    document.getElementById('saveQueryBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('saveQueryModal'));
        modal.show();
    });
    
    // Save query confirm button
    document.getElementById('saveQueryConfirmBtn').addEventListener('click', function() {
        const name = document.getElementById('queryName').value.trim();
        if (!name) {
            alert('Please enter a query name');
            return;
        }
        
        // In a real implementation, this would save to the database
        alert(`Query "${name}" saved successfully!`);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('saveQueryModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('saveQueryForm').reset();
    });
    
    // Export button
    document.getElementById('exportBtn').addEventListener('click', function() {
        alert('Export functionality would be implemented here.\nSupported formats: CSV, Excel, PDF');
    });
    
    // Save as report buttons
    document.getElementById('saveAsReportBtn').addEventListener('click', function() {
        alert('Save as Report functionality would be implemented here');
    });
    
    document.getElementById('saveSqlAsReportBtn').addEventListener('click', function() {
        alert('Save as Report functionality would be implemented here');
    });
    
    // Refresh results button
    document.getElementById('refreshResultsBtn').addEventListener('click', function() {
        // Re-run the current query
        if (document.getElementById('visual-tab').classList.contains('active')) {
            document.getElementById('runQueryBtn').click();
        } else {
            document.getElementById('runSqlBtn').click();
        }
    });
    
    // Initialize with leads module selected
    selectModule('leads');
});
</script>
{% endblock %}