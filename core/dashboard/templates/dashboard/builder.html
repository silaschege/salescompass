{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Dashboard Builder{% endblock %}

{% block content %}
<!-- 1. Include SortableJS Library (Lightweight, High Performance) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Dashboard Builder</h1>
            <p class="text-muted">Drag widgets to build your view. Reorder rows by dragging the handle.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'dashboard:main' %}" class="btn btn-outline-secondary">Cancel</a>
            <button id="save-dashboard-btn" class="btn btn-primary">
                <i class="bi bi-save me-1"></i> Save Dashboard
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- COLUMN 1: Sidebar -->
        <div class="col-md-3">
            <!-- Settings -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="dashboard-name" class="form-label">Dashboard Name</label>
                        <input type="text" class="form-control" id="dashboard-name"
                            value="{{ current_dashboard.name|default:'My Custom Dashboard' }}">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="is-default" {{
                            current_dashboard.is_default|yesno:"checked," }}>
                        <label class="form-check-label" for="is-default">Set as default</label>
                    </div>
                </div>
            </div>

            <!-- Widgets List -->
            <div class="card shadow-sm sticky-top" style="top: 1rem; z-index: 99; max-height: 80vh;">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Available Widgets</h5>
                    <input type="text" id="widget-search" class="form-control form-control-sm mt-2"
                        placeholder="Search widgets...">
                </div>
                <div class="card-body p-2 overflow-auto">
                    <!-- Added ID 'sidebar-widgets' for SortableJS -->
                    <div id="sidebar-widgets" class="d-flex flex-column gap-2">
                        {% for widget in available_widgets %}
                        <div class="widget-source-item card p-2 border-start border-4 {% if widget.category == 'revenue' %}border-success{% elif widget.category == 'leads' %}border-info{% elif widget.category == 'tasks' %}border-warning{% elif widget.category == 'cases' %}border-danger{% else %}border-primary{% endif %}"
                            style="cursor: grab; transition: all 0.2s;" data-type="{{ widget.widget_type }}"
                            data-span="{{ widget.default_span|default:6 }}" data-name="{{ widget.name }}"
                            data-category="{{ widget.category }}"
                            data-icon="{{ widget.icon|default:'bi-grid-3x3-gap' }}">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center flex-grow-1">
                                    <div
                                        class="me-2 text-{% if widget.category == 'revenue' %}success{% elif widget.category == 'leads' %}info{% elif widget.category == 'tasks' %}warning{% elif widget.category == 'cases' %}danger{% else %}primary{% endif %} fs-4">
                                        <i class="{{ widget.icon|default:'bi-grid-3x3-gap' }}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold small d-flex align-items-center gap-1">
                                            {{ widget.name }}
                                            <span class="badge bg-secondary" style="font-size: 0.6rem;">{{
                                                widget.get_category_display }}</span>
                                        </div>
                                        <div class="text-muted" style="font-size: 10px;">{{
                                            widget.description|truncatechars:35 }}</div>
                                    </div>
                                </div>
                                <div class="d-flex gap-1 align-items-center">
                                    <!-- Click to Add Button -->
                                    <button class="btn btn-sm btn-outline-primary add-widget-btn" title="Click to add"
                                        style="padding: 0.15rem 0.4rem; font-size: 0.75rem;">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                    <!-- Drag Handle -->
                                    <i class="bi bi-grip-vertical text-muted"></i>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted">No widgets found.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMN 2: Main Canvas -->
        <div class="col-md-9">
            <div class="card shadow-sm min-vh-100 bg-light border">
                <div class="card-body p-4">
                    <!-- Canvas Container (Sortable Rows) -->
                    <div id="dashboard-canvas" class="d-flex flex-column gap-3" style="min-height: 200px;">
                        <!-- Rows will be injected here -->
                    </div>

                    <!-- Empty State -->
                    <div class="text-center text-muted py-5 mt-5" id="empty-state">
                        <i class="bi bi-layout-text-window-reverse display-1 text-secondary opacity-25"></i>
                        <h4 class="mt-3">Start Building</h4>
                        <p>Click "Add New Row" to begin.</p>
                    </div>

                    <button id="add-row-btn" class="btn btn-outline-primary w-100 mt-4 border-dashed py-3">
                        <i class="bi bi-plus-lg me-1"></i> Add New Row
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= TEMPLATES ================= -->

<!-- Row Template -->
<template id="row-template">
    <div class="dashboard-row card mb-3 border-0 shadow-sm">
        <div class="card-header py-1 px-3 bg-white border d-flex justify-content-between align-items-center row-handle"
            style="cursor: move;">
            <div class="text-muted small"><i class="bi bi-arrows-move me-1"></i> Row</div>
            <button class="btn btn-sm btn-link text-danger p-0 remove-row-btn" title="Remove Row">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <!-- Drop Zone for Widgets -->
        <div class="card-body p-3 row g-3 widget-drop-zone" style="min-height: 100px;">
            <!-- Widgets go here -->
        </div>
    </div>
</template>

<!-- Widget Card Template (The actual item on the dashboard) -->
<template id="widget-card-template">
    <div class="widget-wrapper col-md-6"> <!-- Default Class -->
        <div class="card h-100 border shadow-sm">
            <div class="card-header py-1 px-2 bg-light d-flex justify-content-between align-items-center">
                <span class="fw-bold small widget-title">Widget Name</span>
                <div class="d-flex gap-1">
                    <!-- Resize Controls -->
                    <button class="btn btn-xs btn-light border resize-btn" data-action="shrink" title="Shrink width"><i
                            class="bi bi-dash"></i></button>
                    <button class="btn btn-xs btn-light border resize-btn" data-action="expand" title="Expand width"><i
                            class="bi bi-plus"></i></button>
                    <!-- Settings Button -->
                    <button class="btn btn-xs btn-light border widget-settings-btn" title="Widget Settings"><i
                            class="bi bi-gear"></i></button>
                    <!-- Remove Button -->
                    <button class="btn btn-xs btn-light border text-danger remove-widget-btn" title="Remove"><i
                            class="bi bi-x"></i></button>
                </div>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center bg-white p-3">
                <div class="text-center text-muted opacity-50">
                    <i class="bi bi-bar-chart-fill fs-1"></i>
                    <div class="small mt-1">Preview Unavailable</div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Widget Settings Modal -->
<div class="modal fade" id="widgetSettingsModal" tabindex="-1" aria-labelledby="widgetSettingsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="widgetSettingsModalLabel">
                    <i class="bi bi-gear me-2"></i>Widget Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="widgetSettingsForm">
                    <!-- Widget Title -->
                    <div class="mb-3">
                        <label for="widgetCustomTitle" class="form-label fw-bold">Widget Title</label>
                        <input type="text" class="form-control" id="widgetCustomTitle"
                            placeholder="Custom widget title">
                        <small class="text-muted">Leave empty to use default title</small>
                    </div>

                    <!-- Aggregation Type -->
                    <div class="mb-3">
                        <label for="widgetAggregation" class="form-label fw-bold">Aggregation Type</label>
                        <select class="form-select" id="widgetAggregation">
                            <option value="count">Count (Total Records)</option>
                            <option value="sum">Sum (Total Value)</option>
                            <option value="average">Average</option>
                            <option value="min">Minimum</option>
                            <option value="max">Maximum</option>
                        </select>
                    </div>

                    <!-- Time Range -->
                    <div class="mb-3">
                        <label for="widgetTimeRange" class="form-label fw-bold">Time Range</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="widgetTimeRange" value="30" min="1" max="365">
                            <span class="input-group-text">days</span>
                        </div>
                        <small class="text-muted">Number of days to include in data</small>
                    </div>

                    <!-- Sorting -->
                    <div class="mb-3">
                        <label for="widgetSorting" class="form-label fw-bold">Sort Order</label>
                        <select class="form-select" id="widgetSorting">
                            <option value="desc">Largest to Smallest</option>
                            <option value="asc">Smallest to Largest</option>
                            <option value="recent">Most Recent First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>

                    <!-- Data Source / Module -->
                    <div class="mb-3">
                        <label for="widgetDataSource" class="form-label fw-bold">Data Source</label>
                        <select class="form-select" id="widgetDataSource">
                            <option value="all">All Records</option>
                            <option value="leads">Leads</option>
                            <option value="opportunities">Opportunities</option>
                            <option value="cases">Cases</option>
                            <option value="tasks">Tasks</option>
                            <option value="accounts">Accounts</option>
                        </select>
                    </div>

                    <!-- Filter by User/Team -->
                    <div class="mb-3">
                        <label for="widgetFilter" class="form-label fw-bold">Filter By</label>
                        <select class="form-select" id="widgetFilter">
                            <option value="all">All Users</option>
                            <option value="me">My Records Only</option>
                            <option value="team">My Team</option>
                        </select>
                    </div>

                    <!-- Comparison Option -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Comparison</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="widgetCompareEnabled">
                            <label class="form-check-label" for="widgetCompareEnabled">
                                Enable comparison with previous period
                            </label>
                        </div>
                    </div>

                    <!-- Limit Results -->
                    <div class="mb-3">
                        <label for="widgetLimit" class="form-label fw-bold">Limit Results</label>
                        <input type="number" class="form-control" id="widgetLimit" value="10" min="1" max="100">
                        <small class="text-muted">Maximum number of items to display</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveWidgetSettings">
                    <i class="bi bi-check-circle me-1"></i>Apply Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= STYLES ================= -->
<style>
    .border-dashed {
        border: 2px dashed #dee2e6;
    }

    .sortable-ghost {
        opacity: 0.4;
        background-color: #f8f9fa;
        border: 2px dashed #0d6efd;
    }

    .sortable-drag {
        cursor: grabbing;
    }

    .btn-xs {
        padding: 0.1rem 0.3rem;
        font-size: 0.7rem;
    }

    /* Highlight drop area */
    .widget-drop-zone {
        background-color: #fafafa;
        transition: background 0.2s, border 0.2s;
        border: 2px dashed transparent;
        min-height: 100px;
    }

    .widget-drop-zone.drag-active,
    .widget-drop-zone.drag-over {
        background-color: #e7f3ff;
        border-color: #0d6efd;
    }

    /* Widget Addition Animation */
    @keyframes widgetAdded {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .widget-just-added {
        animation: widgetAdded 0.4s ease-out;
    }

    /* Widget Card Hover Effects */
    .widget-source-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Success Toast (optional - can be used later) */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<!-- ================= SCRIPT ================= -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const canvas = document.getElementById('dashboard-canvas');
        const emptyState = document.getElementById('empty-state');
        const sidebarList = document.getElementById('sidebar-widgets');

        // Configuration
        const CONFIG = {
            csrf: '{{ csrf_token }}',
            saveUrl: '{% url "dashboard:save_dashboard" %}',
            redirectUrl: '/dashboard/render/', // Adjust to your real URL
            layout: '{{ layout_json|default:"{}"|escapejs }}' // Safe load
        };

        // Widget Type to Model Mapping for Auto-Selection
        const WIDGET_TYPE_TO_MODEL = {
            'leads': 'leads',
            'tasks': 'tasks',
            'opportunities': 'opportunities',
            'cases': 'cases',
            'accounts': 'accounts',
            'products': 'products',
            'proposals': 'proposals',
            'sales': 'opportunities',  // Sales typically uses opportunities data
            'revenue': 'opportunities', // Revenue from won opportunities
            'pipeline': 'opportunities', // Pipeline shows opportunities
            'leaderboard': 'opportunities', // Leaderboard based on sales/opportunities
            'activity': 'all', // Activity aggregates multiple sources
            'nps': 'all', // NPS is its own model
            'marketing': 'all', // Marketing campaigns
            'automation': 'all', // Workflow stats
            'tenants': 'all', // Tenant management
            'infrastructure': 'all', // Infrastructure stats
            'communication': 'all', // Communication stats
            'engagement': 'all', // Engagement metrics
            'reports': 'all', // Reports dashboard
            'commissions': 'all', // Commission tracking
            'learn': 'all', // Learning progress
            'developer': 'all', // Developer tools
            'billing': 'all', // Billing overview
            'settings': 'all', // System settings
            'audit_logs': 'all', // Audit logs
            'feature_flags': 'all', // Feature flags
            'global_alerts': 'all' // Global alerts
        };

        // 1. Initialize Sidebar Draggables (Source)
        new Sortable(sidebarList, {
            group: {
                name: 'widgets',
                pull: 'clone', // Clone items, don't remove from sidebar
                put: false     // Don't allow dropping items back into sidebar
            },
            sort: false, // Sidebar items can't be sorted
            animation: 150
        });

        // 2. Initialize Main Canvas (Row Reordering)
        const canvasSortable = new Sortable(canvas, {
            handle: '.row-handle', // Only drag by the header
            animation: 150,
            ghostClass: 'sortable-ghost'
        });

        // --- Helper: Create a New Row ---
        function createRow(insertBefore = null) {
            emptyState.style.display = 'none';
            const template = document.getElementById('row-template');
            const clone = template.content.cloneNode(true);
            const rowEl = clone.querySelector('.dashboard-row');

            // Add Row Delete Logic
            rowEl.querySelector('.remove-row-btn').addEventListener('click', () => {
                if (confirm('Remove this row and all its widgets?')) {
                    rowEl.remove();
                    if (canvas.children.length === 0) emptyState.style.display = 'block';
                }
            });

            // Initialize Sortable for this new Row's drop zone
            const dropZone = rowEl.querySelector('.widget-drop-zone');
            new Sortable(dropZone, {
                group: 'widgets', // Accept items from sidebar or other rows
                animation: 150,
                ghostClass: 'sortable-ghost',
                // When an item is added from Sidebar, transform it
                onAdd: function (evt) {
                    const item = evt.item;
                    // Check if it came from sidebar (has source class)
                    if (item.classList.contains('widget-source-item')) {
                        const type = item.dataset.type;
                        const span = item.dataset.span;
                        const name = item.dataset.name;

                        // Create real widget card
                        const widgetEl = createWidgetElement(type, span, name);

                        // Replace the dragged sidebar item with the real widget
                        item.parentNode.replaceChild(widgetEl, item);
                    }
                }
            });

            if (insertBefore) {
                canvas.insertBefore(rowEl, insertBefore);
            } else {
                canvas.appendChild(rowEl);
            }
            return dropZone;
        }

        // --- Helper: Create Widget Element ---
        function createWidgetElement(type, span, name) {
            const template = document.getElementById('widget-card-template');
            const clone = template.content.cloneNode(true);
            const wrapper = clone.querySelector('.widget-wrapper');

            // Set Data
            wrapper.dataset.type = type;
            wrapper.dataset.span = span;
            wrapper.className = `widget-wrapper col-md-${span}`;
            wrapper.querySelector('.widget-title').textContent = name;

            // Auto-select data source based on widget type
            const autoDataSource = WIDGET_TYPE_TO_MODEL[type] || 'all';

            // Initialize default settings with auto-selected data source
            wrapper.dataset.settings = JSON.stringify({
                customTitle: '',
                aggregation: 'count',
                timeRange: 30,
                sorting: 'desc',
                dataSource: autoDataSource,
                filter: 'all',
                compareEnabled: false,
                limit: 10
            });

            // Bind Settings Button
            wrapper.querySelector('.widget-settings-btn').addEventListener('click', () => {
                openWidgetSettings(wrapper);
            });

            // Bind Remove
            wrapper.querySelector('.remove-widget-btn').addEventListener('click', () => wrapper.remove());

            // Bind Resize
            wrapper.querySelectorAll('.resize-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    let currentSpan = parseInt(wrapper.dataset.span);

                    if (action === 'expand' && currentSpan < 12) currentSpan++;
                    if (action === 'shrink' && currentSpan > 2) currentSpan--;

                    // Update class and data attribute
                    wrapper.className = `widget-wrapper col-md-${currentSpan}`;
                    wrapper.dataset.span = currentSpan;
                });
            });

            return wrapper;
        }

        // --- Helper: Find Available Row (for click-to-add) ---
        function findAvailableRow(requiredSpan) {
            const rows = canvas.querySelectorAll('.dashboard-row');

            // Check each row to see if it has enough space
            for (let row of rows) {
                const remainingSpace = calculateRowRemainingSpace(row);
                if (remainingSpace >= requiredSpan) {
                    return row.querySelector('.widget-drop-zone');
                }
            }

            // No available row found, return null to trigger new row creation
            return null;
        }

        // --- Helper: Calculate Row Remaining Space ---
        function calculateRowRemainingSpace(row) {
            const widgets = row.querySelectorAll('.widget-wrapper');
            let usedSpace = 0;

            widgets.forEach(widget => {
                usedSpace += parseInt(widget.dataset.span || 6);
            });

            return 12 - usedSpace;  // Bootstrap grid is 12 columns
        }

        // --- Click-to-Add Widget ---
        function addWidgetClick(type, span, name, icon) {
            emptyState.style.display = 'none';

            // Find available row or create new one
            let dropZone = findAvailableRow(span);

            if (!dropZone) {
                // Create new row if no space available
                dropZone = createRow();
            }

            // Create and add widget
            const widgetEl = createWidgetElement(type, span, name);
            dropZone.appendChild(widgetEl);

            // Add animation class
            widgetEl.classList.add('widget-just-added');
            setTimeout(() => {
                widgetEl.classList.remove('widget-just-added');
            }, 400);
        }

        // --- Widget Settings Modal Functions ---
        let currentWidgetElement = null;  // Track which widget is being configured
        const settingsModal = new bootstrap.Modal(document.getElementById('widgetSettingsModal'));

        function openWidgetSettings(widgetWrapper) {
            currentWidgetElement = widgetWrapper;

            // Load current settings
            const settings = JSON.parse(widgetWrapper.dataset.settings || '{}');

            // Get widget type for auto-selection
            const widgetType = widgetWrapper.dataset.type;

            // Auto-select data source based on widget type (if not already set)
            const autoDataSource = WIDGET_TYPE_TO_MODEL[widgetType] || 'all';
            const dataSource = settings.dataSource || autoDataSource;

            // Populate form with current values
            document.getElementById('widgetCustomTitle').value = settings.customTitle || '';
            document.getElementById('widgetAggregation').value = settings.aggregation || 'count';
            document.getElementById('widgetTimeRange').value = settings.timeRange || 30;
            document.getElementById('widgetSorting').value = settings.sorting || 'desc';
            document.getElementById('widgetDataSource').value = dataSource;
            document.getElementById('widgetFilter').value = settings.filter || 'all';
            document.getElementById('widgetCompareEnabled').checked = settings.compareEnabled || false;
            document.getElementById('widgetLimit').value = settings.limit || 10;

            // Show modal
            settingsModal.show();
        }

        function saveWidgetSettings() {
            if (!currentWidgetElement) return;

            // Collect form values
            const settings = {
                customTitle: document.getElementById('widgetCustomTitle').value,
                aggregation: document.getElementById('widgetAggregation').value,
                timeRange: parseInt(document.getElementById('widgetTimeRange').value),
                sorting: document.getElementById('widgetSorting').value,
                dataSource: document.getElementById('widgetDataSource').value,
                filter: document.getElementById('widgetFilter').value,
                compareEnabled: document.getElementById('widgetCompareEnabled').checked,
                limit: parseInt(document.getElementById('widgetLimit').value)
            };

            // Save to widget data attribute
            currentWidgetElement.dataset.settings = JSON.stringify(settings);

            // Update widget title if custom title provided
            if (settings.customTitle) {
                currentWidgetElement.querySelector('.widget-title').textContent = settings.customTitle;
            }

            // Close modal
            settingsModal.hide();
            currentWidgetElement = null;
        }

        // Bind save button
        document.getElementById('saveWidgetSettings').addEventListener('click', saveWidgetSettings);

        // --- Bind Click-to-Add Buttons ---
        document.querySelectorAll('.add-widget-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();  // Prevent drag from starting
                e.preventDefault();

                const widgetItem = e.currentTarget.closest('.widget-source-item');
                const type = widgetItem.dataset.type;
                const span = parseInt(widgetItem.dataset.span);
                const name = widgetItem.dataset.name;
                const icon = widgetItem.dataset.icon;

                addWidgetClick(type, span, name, icon);
            });
        });

        // --- 3. Add Row Button Listener ---
        document.getElementById('add-row-btn').addEventListener('click', () => createRow());

        // --- 4. Load Existing Layout ---
        try {
            const layoutData = JSON.parse(CONFIG.layout);
            if (layoutData.rows && layoutData.rows.length > 0) {
                layoutData.rows.forEach(row => {
                    const dropZone = createRow();
                    if (row.cols) {
                        row.cols.forEach(col => {
                            const widget = createWidgetElement(col.widget, col.span, col.name || 'Widget');
                            dropZone.appendChild(widget);
                        });
                    }
                });
            }
        } catch (e) {
            console.error("Layout load error", e);
        }

        // --- 5. Save Dashboard ---
        document.getElementById('save-dashboard-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-dashboard-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            const name = document.getElementById('dashboard-name').value.trim() || 'My Dashboard';
            const isDefault = document.getElementById('is-default').checked;

            // Collect layout
            const rows = [];
            const widgetSettings = {};  // Store widget-specific settings

            canvas.querySelectorAll('.dashboard-row').forEach((row, rowIndex) => {
                const widgets = [];
                row.querySelectorAll('.widget-wrapper').forEach((widget, widgetIndex) => {
                    const widgetId = `${rowIndex}-${widgetIndex}`;

                    // Collect widget layout info
                    widgets.push({
                        type: widget.dataset.type,
                        span: parseInt(widget.dataset.span)
                    });

                    // Collect widget settings
                    if (widget.dataset.settings) {
                        widgetSettings[widgetId] = JSON.parse(widget.dataset.settings);
                    }
                });
                rows.push({ widgets });
            });

            const payload = {
                dashboard_id: CONFIG.dashboardId,
                name,
                is_default: isDefault,
                layout: { rows },
                widget_settings: widgetSettings  // Include widget settings
            };

            try {
                const response = await fetch(CONFIG.saveUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CONFIG.csrf
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = CONFIG.redirectUrl + data.dashboard_id;
                } else {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-save me-1"></i> Save Dashboard';
                }
            } catch (err) {
                console.error(err);
                alert('Network Error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save me-1"></i> Save Dashboard';
            }
        });

        // Search Filter
        document.getElementById('widget-search').addEventListener('keyup', function () {
            const val = this.value.toLowerCase();
            document.querySelectorAll('.widget-source-item').forEach(el => {
                const name = el.dataset.name.toLowerCase();
                el.style.display = name.includes(val) ? 'block' : 'none';
            });
        });

    }); // End of DOMContentLoaded

</script>
{% endblock %}