{% extends "sales/base.html" %}
{% load humanize %}

{% block sales_content %}
<div class="p-4">
    <div class="d-flex justify-content-between align-items-start mb-5">
        <div class="d-flex align-items-center">
            <a href="{% url 'sales:sale_list' %}" class="btn btn-light btn-icon rounded-circle me-3 border-0 shadow-sm">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item small"><a href="{% url 'sales:sale_list' %}"
                                class="text-decoration-none text-muted">Sales Registry</a></li>
                        <li class="breadcrumb-item active small text-primary fw-bold" aria-current="page">SALE-#{{
                            sale.id }}</li>
                    </ol>
                </nav>
                <h1 class="h3 fw-bold mb-0">{{ sale.product.product_name }}</h1>
            </div>
        </div>
        <div class="d-flex gap-2 pt-3">
            <a href="{% url 'sales:sale_update' sale.pk %}" class="btn btn-white border px-4 shadow-sm">
                <i class="bi bi-pencil me-2"></i> Edit Record
            </a>
            <button class="btn btn-primary px-4 shadow-sm border-0">
                <i class="bi bi-check2-circle me-2"></i> Confirm Fulfillment
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- Sidebar Summary -->
        <div class="col-lg-4">
            <div class="premium-card p-4 border-0 shadow-sm mb-4">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="bg-indigo-50 text-indigo-600 rounded p-3">
                        <i class="bi bi-cart-check h3 mb-0"></i>
                    </div>
                    <span
                        class="badge {% if sale.is_recognized %}badge-soft-success{% else %}badge-soft-warning{% endif %} px-3 rounded-pill text-uppercase extra-small">
                        {% if sale.is_recognized %}Recognized{% else %}Deferred{% endif %}
                    </span>
                </div>
                <h5 class="fw-bold mb-1">{{ sale.account.account_name }}</h5>
                <p class="text-muted small mb-4">ID: {{ sale.account.account_id|default:"N/A" }}</p>

                <div class="list-group list-group-flush small border-top pt-3">
                    <div class="list-group-item px-0 py-2 bg-transparent border-0 d-flex justify-content-between">
                        <span class="text-muted">Transaction Date:</span>
                        <span class="fw-bold">{{ sale.sale_date|date:"F d, Y" }}</span>
                    </div>
                    <div class="list-group-item px-0 py-2 bg-transparent border-0 d-flex justify-content-between">
                        <span class="text-muted">Total Amount:</span>
                        <span class="text-dark fw-bold h5 mb-0">${{ sale.amount|intcomma }}</span>
                    </div>
                </div>
            </div>

            <div class="premium-card p-4 border-0 shadow-sm bg-dark text-white overflow-hidden position-relative mb-4">
                <div class="position-absolute bottom-0 end-0 p-3 opacity-10">
                    <i class="bi bi-journal-check" style="font-size: 4rem;"></i>
                </div>
                <h6 class="fw-bold mb-3 small text-uppercase text-primary">IFRS 15 Governance</h6>
                <div class="d-flex flex-column gap-3">
                    <div>
                        <div class="extra-small text-white-50">Current Liability</div>
                        <div class="h3 fw-bold mb-0">${% if not sale.is_recognized %}{{ sale.amount|intcomma }}{% else
                            %}0.00{% endif %}</div>
                    </div>
                    <div>
                        <div class="extra-small text-white-50">Method</div>
                        <div class="fw-bold small">{{ sale.get_sale_type_display }} / Contract Deferral</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Performance Obligations -->
            <div class="premium-card border-0 shadow-sm mb-4">
                <div class="p-4 border-bottom">
                    <h6 class="fw-bold mb-0"><i class="bi bi-list-stars text-primary me-2"></i> Associated Performance
                        Obligations</h6>
                </div>
                <div class="p-4">
                    {% if sale.obligation %}
                    <div class="row g-4 align-items-center">
                        <div class="col-md-6">
                            <div class="fw-bold text-dark">{{ sale.obligation.name }}</div>
                            <div class="extra-small text-muted">{{ sale.obligation.get_recognition_method_display }}
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <span
                                class="badge {% if sale.obligation.status == 'fulfilled' %}badge-soft-success{% else %}badge-soft-info{% endif %} px-3 rounded-pill">
                                {{ sale.obligation.status|upper }}
                            </span>
                        </div>
                        <div class="col-12 mt-3">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary"
                                    style="width: {{ sale.obligation.recognized_amount|default:0 }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between extra-small mt-2 text-muted fw-bold">
                                <span>RECOGNIZED: ${{ sale.obligation.recognized_amount|default:0|intcomma }}</span>
                                <span>TARGET: ${{ sale.obligation.allocated_amount|intcomma }}</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted small">
                        No performance obligation linked. Revenue recognized on booking.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Revenue Schedule -->
            <div class="premium-card border-0 shadow-sm">
                <div class="p-4 border-bottom">
                    <h6 class="fw-bold mb-0"><i class="bi bi-calendar3 text-primary me-2"></i> Recognition Timeline</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light bg-opacity-50 extra-small text-uppercase fw-bold">
                            <tr>
                                <th class="ps-4">Period</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Recognized Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if sale.obligation %}
                            {% for event in sale.obligation.schedules.all %}
                            <tr>
                                <td class="ps-4 py-3">
                                    <div class="fw-bold text-dark">{{ event.date|date:"F Y" }}</div>
                                    <div class="extra-small text-muted">{{ event.date|date:"M d, Y" }}</div>
                                </td>
                                <td>
                                    <span class="badge badge-soft-success px-2 py-1 extra-small">POSTED</span>
                                </td>
                                <td class="text-end pe-4 fw-bold">${{ event.amount|intcomma }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td class="ps-4 py-3">
                                    <div class="fw-bold text-dark">{{ sale.sale_date|date:"F Y" }}</div>
                                </td>
                                <td><span class="badge badge-soft-success px-2 py-1 extra-small">POSTED</span></td>
                                <td class="text-end pe-4 fw-bold">${{ sale.amount|intcomma }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}