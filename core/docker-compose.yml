name: salescompass

services:
  # -----------------------------------
  # CRM / Web Application (your app)
  # -----------------------------------
  web:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    depends_on:
      - db
      - wazo-auth
      - wazo-confd
      - wazo-call-logd
      - wazo-agentd
    environment:
      DATABASE_URL: postgres://user:password@db:5432/salescompass
      WAZO_AUTH_URL: http://wazo-auth:9497
      WAZO_CONFD_URL: http://wazo-confd:9486
      WAZO_CALL_LOG_URL: http://wazo-call-logd:9295
      WAZO_AGENTD_URL: http://wazo-agentd:some_port   # adjust as per agentd default port

  # -----------------------------------
  # Redis for Celery and Channels
  # -----------------------------------
  redis:
    image: redis:7-alpine
    container_name: salescompass-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # -----------------------------------
  # CRM Database
  # -----------------------------------
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: salescompass
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # -----------------------------------
  # Wazo Platform Database
  # -----------------------------------
  wazo-db:
    image: postgres:13
    environment:
      POSTGRES_DB: wazo
      POSTGRES_USER: wazo
      POSTGRES_PASSWORD: wazo
    volumes:
      - wazo_db:/var/lib/postgresql/data

  # -----------------------------------
  # Wazo AUTH Service (authentication, tokens)
  # -----------------------------------
  wazo-auth:
    image: wazoplatform/wazo-auth:latest  # or specific tag
    depends_on:
      - wazo-db
    ports:
      - "9497:9497"
    environment:
      WAZO_DB_URI: postgresql://wazo:wazo@wazo-db/wazo
      WAZO_UUID: salescompass-auth
      WAZO_ADMIN_USERNAME: admin
      WAZO_ADMIN_PASSWORD: securepassword123

  # -----------------------------------
  # Wazo CONFD (configuration daemon)
  # -----------------------------------
  wazo-confd:
    image: wazoplatform/wazo-confd:latest
    depends_on:
      - wazo-auth
    ports:
      - "9486:9486"
    environment:
      WAZO_AUTH_URL: http://wazo-auth:9497
      WAZO_DB_URI: postgresql://wazo:wazo@wazo-db/wazo

  # -----------------------------------
  # Wazo CALL LOGD (call logging)
  # -----------------------------------
  wazo-call-logd:
    image: wazoplatform/wazo-call-logd:latest
    depends_on:
      - wazo-auth
      - wazo-confd
    ports:
      - "9295:9295"
    environment:
      WAZO_AUTH_URL: http://wazo-auth:9497
      WAZO_DB_URI: postgresql://wazo:wazo@wazo-db/wazo

  # -----------------------------------
  # Wazo AGENTD — Call center agent management
  # (handles agent states, queuing, etc.)
  # -----------------------------------
  wazo-agentd:
    image: wazoplatform/wazo-agentd:latest
    depends_on:
      - wazo-auth
      - wazo-confd
    ports:
      - "9493:9493"
    environment:
      WAZO_AUTH_URL: http://wazo-auth:9497
      WAZO_CONFD_URL: http://wazo-confd:9486

  # -----------------------------------
  # Wazo AMID — Bridge to Asterisk
  # -----------------------------------
  wazo-amid:
    image: wazoplatform/wazo-amid:latest
    depends_on:
      - wazo-db
      - wazo-confd
      - asterisk
    environment:
      WAZO_DB_URI: postgresql://wazo:wazo@wazo-db/wazo
      WAZO_AMID_AMI_HOST: asterisk
      WAZO_AMID_AMI_PORT: 5038
    ports:
      - "4573:4573"

  # -----------------------------------
  # Wazo CALLD — Call daemon (REQUIRED for making/receiving calls)
  # Handles call initiation, transfer, hold, etc.
  # -----------------------------------
  wazo-calld:
    image: wazoplatform/wazo-calld:latest
    depends_on:
      - wazo-auth
      - wazo-confd
      - wazo-amid
      - asterisk
    ports:
      - "9500:9500"
    environment:
      WAZO_AUTH_URL: http://wazo-auth:9497
      WAZO_CONFD_URL: http://wazo-confd:9486
      WAZO_AMID_URL: http://wazo-amid:4573
      WAZO_CALLD_ARI_URL: http://asterisk:8088
      WAZO_CALLD_ARI_USERNAME: xivo
      WAZO_CALLD_ARI_PASSWORD: xivo

  # -----------------------------------
  # Wazo CHATD — Chat/SMS daemon (REQUIRED for SMS/messaging)
  # Handles SMS, WhatsApp, and instant messaging
  # -----------------------------------
  wazo-chatd:
    image: wazoplatform/wazo-chatd:latest
    depends_on:
      - wazo-auth
      - wazo-db
    ports:
      - "9304:9304"
    environment:
      WAZO_AUTH_URL: http://wazo-auth:9497
      WAZO_DB_URI: postgresql://wazo:wazo@wazo-db/wazo

  # -----------------------------------
  # Wazo WEBHOOKD — Webhook daemon for external integrations
  # Sends events to SalesCompass CRM
  # -----------------------------------
  wazo-webhookd:
    image: wazoplatform/wazo-webhookd:latest
    depends_on:
      - wazo-auth
      - wazo-db
    ports:
      - "9300:9300"
    environment:
      WAZO_AUTH_URL: http://wazo-auth:9497
      WAZO_DB_URI: postgresql://wazo:wazo@wazo-db/wazo

  # -----------------------------------
  # Asterisk PBX — Telephony core
  # Handles SIP, RTP, and media processing
  # -----------------------------------
  asterisk:
    image: wazoplatform/asterisk:latest
    depends_on:
      - wazo-db
    ports:
      - "5060:5060/udp"               # SIP UDP
      - "5060:5060/tcp"               # SIP TCP
      - "8088:8088"                   # ARI WebSocket
      - "5038:5038"                   # AMI
      - "10000-10100:10000-10100/udp" # RTP media ports
    volumes:
      - asterisk_recordings:/var/spool/asterisk/recording
      - asterisk_voicemail:/var/spool/asterisk/voicemail
      - asterisk_logs:/var/log/asterisk
    environment:
      WAZO_DB_URI: postgresql://wazo:wazo@wazo-db/wazo
    restart: unless-stopped

volumes:
  postgres_data: {}
  wazo_db: {}
  redis_data: {}
  asterisk_recordings: {}
  asterisk_voicemail: {}
  asterisk_logs: {}

