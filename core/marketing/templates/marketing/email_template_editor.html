{% extends "base.html" %}

{% block title %}Email Template Editor - {{ object.name }}{% endblock %}

{% block content %}
<h1>Email Template Editor</h1>

<form method="post">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-8">
            <!-- Subject -->
            <div class="mb-3">
                <label class="form-label">Subject</label>
                {{ form.subject }}
            </div>
            
            <!-- HTML Editor -->
            <div class="mb-3">
                <label class="form-label">HTML Content</label>
                <textarea name="html_content" id="id_html_content" class="form-control">{{ object.html_content }}</textarea>
            </div>
            
            <!-- Plain Text -->
            <div class="mb-3">
                <label class="form-label">Plain Text (for accessibility)</label>
                {{ form.plain_text_content }}
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Merge Tags -->
            <div class="card">
                <div class="card-header">
                    <h5>Merge Tags</h5>
                </div>
                <div class="card-body">
                    <p>Insert these tags to personalize emails:</p>
                    <div class="list-group">
                        {% for tag in merge_tags %}
                        <button type="button" 
                                class="list-group-item list-group-item-action insert-tag"
                                data-tag="{{ tag }}">
                            {{ "{{ " }}{{ tag }}{{ " }}" }}"}}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Preview Button -->
            <div class="mt-3">
                <button type="button" class="btn btn-outline-secondary w-100" id="preview-email">
                    üëÅÔ∏è Preview Email
                </button>
            </div>
        </div>
    </div>
    
    <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">üíæ Save Template</button>
        <a href="{% url 'marketing:template_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<!-- Email Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Email Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview will be injected here -->
            </div>
        </div>
    </div>
</div>

<!-- TinyMCE -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
tinymce.init({
    selector: '#id_html_content',
    height: 500,
    menubar: false,
    plugins: [
        'advlist autolink lists link image charmap print preview anchor',
        'searchreplace visualblocks code fullscreen',
        'insertdatetime media table paste code help wordcount'
    ],
    toolbar: 'undo redo | formatselect | bold italic backcolor | \
              alignleft aligncenter alignright alignjustify | \
              bullist numlist outdent indent | removeformat | help',
    content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }'
});

// Insert merge tag
document.querySelectorAll('.insert-tag').forEach(button => {
    button.addEventListener('click', function() {
        const tag = this.dataset.tag;
        tinymce.activeEditor.insertContent(`{{ ${tag} }}`);
    });
});

// Preview email
document.getElementById('preview-email').addEventListener('click', function() {
    const content = tinymce.activeEditor.getContent();
    document.getElementById('previewContent').innerHTML = `
        <div style="max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif;">
            ${content}
        </div>
    `;
    new bootstrap.Modal(document.getElementById('previewModal')).show();
});
</script>
{% endblock %}