{% extends "automation/base.html" %}

{% block title %}Workflow Builder - SalesCompass{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>Workflow Builder</h1>
    
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Elements</h5>
                </div>
                <div class="card-body">
                    <div class="elements-list">
                        <div class="element draggable" data-type="trigger">
                            <i class="bi bi-play-circle"></i> Trigger
                        </div>
                        <div class="element draggable" data-type="action">
                            <i class="bi bi-gear"></i> Action
                        </div>
                        <div class="element draggable" data-type="condition">
                            <i class="bi bi-code"></i> Condition
                        </div>
                        <div class="element draggable" data-type="decision">
                            <i class="bi bi-braces"></i> Decision
                        </div>
                        <div class="element draggable" data-type="end">
                            <i class="bi bi-stop-circle"></i> End
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Templates</h6>
                    {% for template in templates %}
                    <div class="template-item" data-template-id="{{ template.id }}">
                        {{ template.workflow_template_name }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h5>
                        {% if workflow %}
                            Editing: {{ workflow.workflow_name }}
                        {% else %}
                            New Workflow
                        {% endif %}
                    </h5>
                    <div>
                        <button id="save-workflow-btn" class="btn btn-primary">Save</button>
                        <button id="run-workflow-btn" class="btn btn-success">Run Test</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="workflow-canvas" class="workflow-canvas">
                        <!-- Workflow canvas will be populated by JavaScript -->
                        <div id="drawflow"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Properties</h5>
                </div>
                <div class="card-body">
                    <div id="properties-panel">
                        <p>Select an element to edit its properties</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/drawflow@0.0.58/dist/drawflow.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/drawflow@0.0.58/dist/drawflow.min.css" rel="stylesheet">

<style>
    .workflow-canvas {
        height: 600px;
        border: 1px solid #ccc;
        overflow: auto;
    }
    
    .elements-list .element {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: grab;
    }
    
    .elements-list .element:hover {
        background: #e9ecef;
    }
    
    .template-item {
        padding: 8px;
        margin: 3px 0;
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .template-item:hover {
        background: #ade4f1;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('drawflow');
        const editor = new Drawflow(canvas);
        editor.start();

        // Load workflow data if available
        {% if workflow_data %}
        try {
            const workflowData = JSON.parse('{{ workflow_data|safe }}');
            editor.import(workflowData);
        } catch (e) {
            console.log('No existing workflow data to load');
        }
        {% endif %}

        // Handle element dragging
        const elements = document.querySelectorAll('.draggable');
        elements.forEach(element => {
            element.addEventListener('dragstart', dragStart);
        });

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.type);
        }

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('text/plain');
            const rect = canvas.getBoundingClientRect();
            const pos = editor.canvasToClientXY(e.clientX - rect.left, e.clientY - rect.top);
            
            // Add new node based on type
            switch(type) {
                case 'trigger':
                    editor.addNode('trigger', 1, 1, pos.x, pos.y, 'trigger', { event_type: 'account.created' }, 'Trigger');
                    break;
                case 'action':
                    editor.addNode('action', 2, 1, pos.x, pos.y, 'action', { action_type: 'send_email' }, 'Action');
                    break;
                case 'condition':
                    editor.addNode('condition', 2, 1, pos.x, pos.y, 'condition', { field: '', operator: 'eq', value: '' }, 'Condition');
                    break;
                case 'decision':
                    editor.addNode('decision', 2, 2, pos.x, pos.y, 'decision', {}, 'Decision');
                    break;
                case 'end':
                    editor.addNode('end', 1, 1, pos.x, pos.y, 'end', {}, 'End');
                    break;
            }
        });

        // Save workflow button
        document.getElementById('save-workflow-btn').addEventListener('click', function() {
            const workflowData = editor.export();
            const workflowName = prompt('Enter workflow name:', '{{ workflow.workflow_name|default:"New Workflow" }}');
            
            if (workflowName) {
                fetch('{% url "automation:save_workflow" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        name: workflowName,
                        workflow_data: workflowData,
                        {% if workflow_id %}
                        id: {{ workflow_id }},
                        {% endif %}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Workflow saved successfully!');
                        if (!{{ workflow_id|default:0 }}) {
                            window.location.href = `/automation/builder/${data.workflow_id}/`;
                        }
                    } else {
                        alert('Error saving workflow: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving the workflow.');
                });
            }
        });

        // Template loading
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', function() {
                const templateId = this.dataset.templateId;
                // Load template data via AJAX
                fetch(`/automation/api/load-template/${templateId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editor.clear();
                        editor.import(data.template.workflow_template_builder_data);
                    }
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                });
            });
        });
    });
</script>
{% endblock %}
