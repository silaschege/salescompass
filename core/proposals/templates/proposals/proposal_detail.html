{% extends "proposals/base.html" %}
{% load auth_extras task_tags %}

{% block title %}{{ proposal.title }} - SalesCompass{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h1 class="block-title fw-bold mb-0">{{ proposal.title }}</h1>
        <span
            class="badge bg-{% if proposal.status == 'accepted' %}success{% elif proposal.status == 'rejected' %}danger{% elif proposal.status == 'viewed' %}info{% elif proposal.status == 'sent' %}warning{% else %}secondary{% endif %}">
            {{ proposal.get_status_display }}
        </span>
        {% if proposal.esg_section_viewed %}
        <span class="badge bg-success">ðŸŒ± ESG Viewed</span>
        {% endif %}
    </div>
    <div>
        {% if request.user.is_authenticated and request.user|has_perm:"proposals:write" %}
        <a href="{% url 'proposals:edit' proposal.pk %}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <!-- Add editor link -->
        <a href="{% url 'proposals:editor' proposal.pk %}" class="btn btn-outline-primary me-2">
            <i class="bi bi-layout-wtf"></i> Edit with Editor
        </a>
        <a href="{% url 'proposals:proposal_delete' proposal.pk %}" class="btn btn-outline-danger">Delete</a>
        {% endif %}
        <!-- Tasks Widget -->
        <div class="mt-4 mb-4">
            {% render_object_tasks proposal %}
        </div>
        <!-- Add this section after the engagement metrics card -->
        {% if proposal.approval_template %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Approval Workflow: {{ proposal.approval_template.name }}</h5>
                </div} <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Status</th>
                                <th>Approver</th>
                                <th>Comments</th>
                                <th>Approved At</th>
                                </tr} </thead} <tbody>
                                {% for approval in proposal.approvals.all %}
                            <tr
                                class="{% if approval.is_approved %}{% if approval.is_approved %}table-success{% elif approval.is_approved is False %}table-danger{% else %}table-light{% endif %}{% endif %}">
                                <td>{{ approval.step.name }}</td>
                                <td>
                                    {% if approval.is_approved is None %}
                                    Pending
                                    {% elif approval.is_approved %}
                                    Approved
                                    {% else %}
                                    Rejected
                                    {% endif %}
                                </td>
                                <td>{{ approval.approved_by.get_full_name }}</td>
                                <td>{{ approval.comments|truncatechars:50|default:"-" }}</td>
                                <td>{{ approval.approved_at|date:"M d, Y H:i" }}</td>
                            </tr>
                            {% endfor %}
                            </tbody} </table>
                </div>

                <div class="mt-3 d-flex justify-content-between">
                    {% if user_can_approve %}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approvalModal">
                        Submit Approval
                    </button>
                    {% endif %}

                    <a href="{% url 'proposals:proposal_approval' proposal.pk %}" class="btn btn-outline-primary">
                        View Approval Details
                    </a>
                </div>
                </div} </div>
                {% endif %}
                {% if proposal.signature %}
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Signature</h5>
                    </div>
                    <div class="card-body">
                        <div class="signature-display mb-3">
                            <img src="{{ proposal.signature.signature_data }}" alt="Proposal Signature"
                                style="max-width: 100%;">
                        </div>
                        <p class="mb-1"><strong>Signed by:</strong> {{ proposal.signature.signer_name }}</p>
                        <p class="mb-1"><strong>Title:</strong> {{ proposal.signature.signer_title }}</p>
                        <p class="mb-0"><strong>Date:</strong> {{ proposal.signature.signed_at|date:"M d, Y H:i" }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ... rest of the template ... -->
        {% endblock %}