{% extends "leads/base.html" %}
{% load static %}

{% block title %}Pipeline - SalesCompass{% endblock %}

{% block content %}
<div class="header-bar mb-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="block-title">Lead Pipeline</h1>
                <p class="text lead mb-0">Visualize and manage your lead flow</p>
            </div>
            <div>
                <a href="{% url 'leads:create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-lg"></i> New Lead
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <!-- Stats Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                        <i class="bi bi-funnel text-primary fs-4"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">Total Pipeline</h6>
                        <h3 class="mb-0">{{ total_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                        <i class="bi bi-check-lg text-success fs-4"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">Qualified</h6>
                        <h3 class="mb-0">{{ qualified_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                        <i class="bi bi-calendar-plus text-info fs-4"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">New This Week</h6>
                        <h3 class="mb-0">{{ new_this_week }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="kanban-container">
        <div class="d-flex gap-4 overflow-auto pb-4" style="min-height: 600px;">
            {% for status in statuses %}
            <div class="kanban-column" style="min-width: 300px; width: 300px;">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-header bg-white border-bottom-0 py-3 sticky-top"
                        style="border-top: 3px solid var(--bs-{{ status.color|default:'primary' }});">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold">{{ status.label }}</h6>
                            <span class="badge bg-light text-dark border">{{ status.lead_count }}</span>
                        </div>
                    </div>
                    <div class="card-body p-2 kanban-droppable" data-status-id="{{ status.id }}">
                        {% for lead in status.leads %}
                        <div class="card border-0 shadow-sm mb-2 kanban-card cursor-grab" draggable="true"
                            data-lead-id="{{ lead.id }}">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge bg-light text-dark border">{{lead.source}}</span>
                                    {% if lead.score %}
                                    <span
                                        class="badge bg-{% if lead.score > 70 %}success{% elif lead.score > 40 %}warning{% else %}danger{% endif %}">
                                        {{ lead.score }}
                                    </span>
                                    {% endif %}
                                </div>
                                <h6 class="card-title mb-1">
                                    <a href="{% url 'leads:detail' lead.id %}"
                                        class="text-decoration-none text-dark stretched-link">
                                        {{ lead.name }}
                                    </a>
                                </h6>
                                <p class="card-text small text-muted mb-2">{{ lead.company }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .cursor-grab {
        cursor: grab;
    }

    .cursor-grabbing {
        cursor: grabbing;
    }

    .kanban-droppable.drag-over {
        background-color: rgba(111, 66, 193, 0.1);
        border-radius: 0.25rem;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.kanban-card');
        const columns = document.querySelectorAll('.kanban-droppable');

        cards.forEach(card => {
            card.addEventListener('dragstart', dragStart);
            card.addEventListener('dragend', dragEnd);
        });

        columns.forEach(column => {
            column.addEventListener('dragover', dragOver);
            column.addEventListener('dragenter', dragEnter);
            column.addEventListener('dragleave', dragLeave);
            column.addEventListener('drop', drop);
        });

        function dragStart() {
            this.classList.add('opacity-50', 'cursor-grabbing');
            this.dataset.dragging = 'true';
        }

        function dragEnd() {
            this.classList.remove('opacity-50', 'cursor-grabbing');
            delete this.dataset.dragging;
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function dragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function dragLeave() {
            this.classList.remove('drag-over');
        }

        function drop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const card = document.querySelector('[data-dragging="true"]');
            const leadId = card.dataset.leadId;
            const newStatusId = this.dataset.statusId;

            // Optimistic UI update
            this.appendChild(card);

            // API Call
            fetch(`/leads/api/update-status/${leadId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ status_id: newStatusId })
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        // Revert on failure (reload page for simplicity)
                        location.reload();
                    } else {
                        // Update score badge if changed
                        if (data.new_score) {
                            const scoreBadge = card.querySelector('.badge.bg-success, .badge.bg-warning, .badge.bg-danger');
                            if (scoreBadge) {
                                scoreBadge.textContent = data.new_score;
                                // Update color class logic here if needed
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    location.reload();
                });
        }
    });
</script>
{% endblock %} lets focus on implementing the infrastrucuture model its implementations its views and base that
constists its navigation,and business logic