{% extends "settings_app/base.html" %}
{% block title %}{% if object %}Edit Role{% else %}Create Role{% endif %} - SalesCompass{% endblock %}

{% block content %}
<div class="header-bar mb-4">
    <div class="container">
        <h1 class="block-title">{% if object %}Edit Role{% else %}Create Role{% endif %}</h1>
        <p class="text-white text-center lead">Define role permissions</p>
    </div>
</div>

<div class="container">
    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <div class="mb-3">
                    <label for="id_name" class="form-label">Role Name</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                    <div class="text-danger">{{ form.name.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="id_description" class="form-label">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="text-danger">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label d-block">Permissions Matrix</label>
                    <p class="text-muted small">Select the permissions for this role. Use row/column headers to select
                        all.</p>

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 200px;">Resource</th>
                                    {% for action in actions %}
                                    <th class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input select-col" type="checkbox"
                                                data-col="{{ action }}" title="Select all {{ action }}">
                                            <span class="ms-1">{{ action|title }}</span>
                                        </div>
                                    </th>
                                    {% endfor %}
                                    <th class="text-center">All</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for resource in resources %}
                                <tr>
                                    <td class="fw-bold">
                                        <div class="form-check">
                                            <input class="form-check-input select-row" type="checkbox"
                                                data-row="{{ resource }}" title="Select all for {{ resource }}">
                                            <span class="ms-1">{{ resource|title }}</span>
                                        </div>
                                    </td>
                                    {% for action in actions %}
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input perm-check" type="checkbox"
                                                data-perm="{{ resource }}:{{ action }}" data-row="{{ resource }}"
                                                data-col="{{ action }}">
                                        </div>
                                    </td>
                                    {% endfor %}
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input select-row-all" type="checkbox"
                                                data-row="{{ resource }}">
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Hidden field to store the JSON list -->
                    {{ form.base_permissions }}
                    {% if form.base_permissions.errors %}
                    <div class="text-danger">{{ form.base_permissions.errors }}</div>
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save Role</button>
                    <a href="{% url 'settings_app:role_list' %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #id_name,
    #id_description {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }

    #id_description {
        min-height: 80px;
    }

    /* Matrix styling */
    .table th,
    .table td {
        vertical-align: middle;
    }

    .table-active-custom {
        background-color: #e8f0fe !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const basePermsInput = document.getElementById('id_base_permissions');
        const checkboxes = document.querySelectorAll('.perm-check');

        // 1. Initialize checkboxes from hidden input
        let currentPerms = [];
        try {
            const val = basePermsInput.value;
            if (val) {
                const jsonStr = val.replace(/'/g, '"');
                currentPerms = JSON.parse(jsonStr);
            }
        } catch (e) {
            console.error("Error parsing permissions:", e);
            currentPerms = [];
        }

        checkboxes.forEach(cb => {
            if (currentPerms.includes(cb.dataset.perm)) {
                cb.checked = true;
                highlightCell(cb);
            }
        });

        function highlightCell(checkbox) {
            const cell = checkbox.closest('td');
            if (cell) {
                if (checkbox.checked) {
                    cell.classList.add('table-active-custom');
                } else {
                    cell.classList.remove('table-active-custom');
                }
            }
        }

        // 2. Update hidden input on change
        function updatePermissions() {
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selected.push(cb.dataset.perm);
                }
                highlightCell(cb);
            });
            basePermsInput.value = JSON.stringify(selected);
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updatePermissions));

        // 3. Select All Row/Col Logic
        document.querySelectorAll('.select-col').forEach(sc => {
            sc.addEventListener('change', function () {
                const col = this.dataset.col;
                document.querySelectorAll(`.perm-check[data-col="${col}"]`).forEach(cb => {
                    cb.checked = this.checked;
                    highlightCell(cb);
                });
                updatePermissions();
            });
        });

        document.querySelectorAll('.select-row, .select-row-all').forEach(sr => {
            sr.addEventListener('change', function () {
                const row = this.dataset.row;
                document.querySelectorAll(`.perm-check[data-row="${row}"]`).forEach(cb => {
                    cb.checked = this.checked;
                    highlightCell(cb);
                });
                updatePermissions();
            });
        });
    });
</script>
{% endblock %}