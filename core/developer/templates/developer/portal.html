{% extends 'developer/base.html' %}
{% load static %}

{% block title %}Developer Portal - SalesCompass{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Developer Portal</h1>

            <!-- Usage Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ stats.total_api_keys }}</h5>
                            <p class="card-text text-muted">Total API Keys</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">{{ stats.active_api_keys }}</h5>
                            <p class="card-text text-muted">Active Keys</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ stats.total_webhooks }}</h5>
                            <p class="card-text text-muted">Webhooks</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">
                                <span class="text-success">{{ stats.successful_webhooks }}</span> /
                                <span class="text-danger">{{ stats.failed_webhooks }}</span>
                            </h5>
                            <p class="card-text text-muted">Success / Failures</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- API Key Management -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">API Keys</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                data-bs-target="#createKeyModal">
                                Create New Key
                            </button>
                        </div>
                        <div class="card-body">
                            {% if api_keys %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Prefix</th>
                                            <th>Status</th>
                                            <th>Last Used</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key in api_keys|slice:":5" %}
                                        <tr>
                                            <td>{{ key.name }}</td>
                                            <td><code>{{ key.key_prefix }}...</code></td>
                                            <td>
                                                {% if key.is_active %}
                                                <span class="badge bg-success">Active</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ key.last_used|date:"Y-m-d"|default:"Never" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <a href="{% url 'developer:api_keys' %}" class="btn btn-sm btn-outline-primary">View All</a>
                            {% else %}
                            <p class="text-muted">No API keys yet. Create one to get started!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Webhook Testing Tool -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Webhook Testing</h5>
                        </div>
                        <div class="card-body">
                            {% if webhooks %}
                            <form id="webhookTestForm">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label">Select Webhook</label>
                                    <select class="form-select" name="webhook_id" required>
                                        <option value="">Choose a webhook...</option>
                                        {% for webhook in webhooks %}
                                        <option value="{{ webhook.id }}">{{ webhook.name }} ({{
                                            webhook.url|truncatechars:40 }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Event Type</label>
                                    <input type="text" class="form-control" name="event_type" value="test.event"
                                        required>
                                </div>
                                <button type="submit" class="btn btn-primary">Send Test Event</button>
                            </form>
                            <div id="webhookTestResult" class="mt-3"></div>
                            {% else %}
                            <p class="text-muted">No webhooks configured. <a
                                    href="{% url 'developer:webhooks' %}">Create one</a> to test!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Examples -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Code Examples</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab"
                                data-bs-target="#python-tab">Python</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab"
                                data-bs-target="#javascript-tab">JavaScript</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#curl-tab">cURL</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <!-- Python -->
                        <div class="tab-pane fade show active" id="python-tab">
                            <h6>Python Example - List Leads</h6>
                            <pre class="bg-light p-3 rounded"><code>import requests

API_KEY = "YOUR_API_KEY"
BASE_URL = "{{ base_url }}"

headers = {
    "Authorization": f"Bearer {API_KEY}",
    "Content-Type": "application/json"
}

# List leads
response = requests.get(f"{BASE_URL}/api/leads/", headers=headers)
leads = response.json()

print(f"Found {len(leads)} leads")
for lead in leads:
    print(f"- {lead['first_name']} {lead['last_name']} ({lead['email']})")</code></pre>
                        </div>

                        <!-- JavaScript -->
                        <div class="tab-pane fade" id="javascript-tab">
                            <h6>JavaScript Example - Create Lead</h6>
                            <pre class="bg-light p-3 rounded"><code>const API_KEY = "YOUR_API_KEY";
const BASE_URL = "{{ base_url }}";

async function createLead(leadData) {
    const response = await fetch(`${BASE_URL}/api/leads/`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(leadData)
    });
    
    const data = await response.json();
    return data;
}

// Example usage
createLead({
    first_name: "John",
    last_name: "Doe",
    email: "john@example.com",
    phone: "+1234567890"
}).then(lead => {
    console.log("Lead created:", lead);
});</code></pre>
                        </div>

                        <!-- cURL -->
                        <div class="tab-pane fade" id="curl-tab">
                            <h6>cURL Example - Update Opportunity</h6>
                            <pre class="bg-light p-3 rounded"><code># List opportunities
curl -X GET "{{ base_url }}/api/opportunities/" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json"

# Update opportunity stage
curl -X PATCH "{{ base_url }}/api/opportunities/123/" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "stage": "negotiation",
    "amount": 50000
  }'</code></pre>
                        </div>
                    </div>

                    <div class="mt-3">
                        <a href="/api/docs/" target="_blank" class="btn btn-outline-primary">View Full API
                            Documentation</a>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Developer Resources</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Documentation</h6>
                            <ul class="list-unstyled">
                                <li><a href="/api/docs/" target="_blank">Swagger UI</a></li>
                                <li><a href="/api/redoc/" target="_blank">Redoc</a></li>
                                <li><a href="/api/schema/" target="_blank">OpenAPI Schema</a></li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Management</h6>
                            <ul class="list-unstyled">
                                <li><a href="{% url 'developer:api_keys' %}">Manage API Keys</a></li>
                                <li><a href="{% url 'developer:webhooks' %}">Manage Webhooks</a></li>
                                <li><a href="{% url 'developer:analytics' %}">Usage Analytics</a></li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Support</h6>
                            <ul class="list-unstyled">
                                <li><a href="#">API Status</a></li>
                                <li><a href="#">Report Issue</a></li>
                                <li><a href="#">Contact Support</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'developer:generate_key' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Create API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Key Name</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., Production App" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="scopes" value="read" checked>
                            <label class="form-check-label">Read access</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="scopes" value="write">
                            <label class="form-check-label">Write access</label>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <small>⚠️ You will only see the full API key once. Save it in a secure location.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Key</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('webhookTestForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const resultDiv = document.getElementById('webhookTestResult');

        try {
            const response = await fetch('{% url "developer:test_webhook" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success">✓ ' + data.message + '</div>';
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger">✗ ' + data.error + '</div>';
            }
        } catch (error) {
            resultDiv.innerHTML = '<div class="alert alert-danger">✗ Error: ' + error.message + '</div>';
        }
    });
</script>
{% endblock %}