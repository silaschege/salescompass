{% extends "pos/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Transactions{% endblock %}

{% block pos_content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Transactions</h1>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed
                        </option>
                        <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Draft</option>
                        <option value="voided" {% if request.GET.status == 'voided' %}selected{% endif %}>Voided</option>
                        <option value="refunded" {% if request.GET.status == 'refunded' %}selected{% endif %}>Refunded
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    <input type="date" name="date" class="form-control" value="{{ request.GET.date }}">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="feather icon-filter me-1"></i>Filter
                    </button>
                    <a href="{% url 'pos:transaction_list' %}" class="btn btn-outline-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Transaction #</th>
                            <th>Terminal</th>
                            <th>Cashier</th>
                            <th>Customer</th>
                            <th class="text-end">Items</th>
                            <th class="text-end">Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in transactions %}
                        <tr>
                            <td>
                                <a href="{% url 'pos:transaction_detail' txn.pk %}" class="fw-bold">
                                    {{ txn.transaction_number }}
                                </a>
                            </td>
                            <td>{{ txn.terminal.terminal_name }}</td>
                            <td>{{ txn.cashier.get_full_name|default:txn.cashier.username }}</td>
                            <td>{{ txn.customer.account_name|default:txn.customer_name|default:"â€”" }}</td>
                            <td class="text-end">{{ txn.lines.count }}</td>
                            <td class="text-end fw-bold">{{ txn.total_amount|floatformat:2|intcomma }}</td>
                            <td>
                                {% if txn.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                                {% elif txn.status == 'draft' %}
                                <span class="badge bg-secondary">Draft</span>
                                {% elif txn.status == 'voided' %}
                                <span class="badge bg-danger">Voided</span>
                                {% elif txn.status == 'refunded' %}
                                <span class="badge bg-warning">Refunded</span>
                                {% elif txn.status == 'on_hold' %}
                                <span class="badge bg-info">On Hold</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ txn.status|title }}</span>
                                {% endif %}
                            </td>
                            <td>{{ txn.created_at|date:"M d, H:i" }}</td>
                            <td class="text-end">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                        data-bs-toggle="dropdown">
                                        <i class="feather icon-more-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'pos:transaction_detail' txn.pk %}">
                                                <i class="feather icon-eye me-2"></i>View Details
                                            </a>
                                        </li>
                                    {% if txn.status == 'completed' %}
                                        <li>
                                            <a class="dropdown-item" href="{% url 'pos:refund_create' txn.pk %}">
                                                <i class="feather icon-rotate-ccw me-2"></i>Create Refund
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-danger"
                                                href="{% url 'pos:transaction_void' txn.pk %}">
                                                <i class="feather icon-x-circle me-2"></i>Void Transaction
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </td>
                            {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white py-3">
            {% include "components/_pagination.html" %}
        </div>
        {% else %}
        <div class="card-body">
            {% include "components/_empty_state.html" with icon="bi-receipt" title="No transactions found" message="Try adjusting your filters or search criteria." %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}