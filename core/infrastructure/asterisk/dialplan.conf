; ========================================
; SalesCompass Dialplan for Asterisk
; Handles inbound/outbound call routing via Twilio
; ========================================

; ----------------------------------------
; Internal Extensions Context (1XXX)
; ----------------------------------------
[from-internal]
; Internal extension calls
exten => _1XXX,1,NoOp(Internal call to ${EXTEN})
 same => n,Set(CALLERID(name)=${CDR(src)})
 same => n,Dial(PJSIP/${EXTEN},30,tT)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy:noanswer)
 same => n(busy),VoiceMail(${EXTEN}@default,b)
 same => n,Hangup()
 same => n(noanswer),VoiceMail(${EXTEN}@default,u)
 same => n,Hangup()

; Outbound calls via Twilio - US format with +1
exten => _+1NXXXXXXXXX,1,NoOp(Outbound call to ${EXTEN})
 same => n,Set(CALLERID(num)=${TWILIO_CALLER_ID})
 same => n,Set(CALLERID(name)=SalesCompass)
 same => n,Set(CDR(accountcode)=twilio-outbound)
 same => n,Dial(PJSIP/${EXTEN}@twilio-endpoint,60,tT)
 same => n,Hangup()

; Outbound calls - US format without +
exten => _1NXXXXXXXXX,1,Goto(from-internal,+${EXTEN},1)

; Outbound calls - 10-digit format (add +1)
exten => _NXXXXXXXXX,1,Goto(from-internal,+1${EXTEN},1)

; International calls (starts with +)
exten => _+X.,1,NoOp(International call to ${EXTEN})
 same => n,Set(CALLERID(num)=${TWILIO_CALLER_ID})
 same => n,Set(CALLERID(name)=SalesCompass)
 same => n,Dial(PJSIP/${EXTEN}@twilio-endpoint,60,tT)
 same => n,Hangup()

; ----------------------------------------
; Inbound Calls from Twilio
; ----------------------------------------
[from-twilio]
; Handle incoming DID calls
exten => _X.,1,NoOp(Inbound call from ${CALLERID(num)} to DID ${EXTEN})
 same => n,Set(CDR(did)=${EXTEN})
 same => n,Set(CDR(accountcode)=twilio-inbound)
 same => n,Answer()
 same => n,Wait(1)
 ; Send to IVR or ring group - customize as needed
 same => n,Goto(ivr-main,s,1)

; Fallback handler
exten => i,1,NoOp(Invalid extension)
 same => n,Playback(invalid)
 same => n,Hangup()

; ----------------------------------------
; IVR Main Menu
; ----------------------------------------
[ivr-main]
exten => s,1,NoOp(IVR Main Menu)
 same => n,Set(TIMEOUT(response)=10)
 same => n,Background(custom/welcome)
 same => n,WaitExten(5)

; Sales
exten => 1,1,Dial(PJSIP/1001&PJSIP/1002&PJSIP/1003,30,tT)
 same => n,VoiceMail(1000@default,u)
 same => n,Hangup()

; Support
exten => 2,1,Dial(PJSIP/1004&PJSIP/1005,30,tT)
 same => n,VoiceMail(2000@default,u)
 same => n,Hangup()

; Operator
exten => 0,1,Dial(PJSIP/1001,30,tT)
 same => n,VoiceMail(1001@default,u)
 same => n,Hangup()

; Timeout - ring all
exten => t,1,Dial(PJSIP/1001&PJSIP/1002&PJSIP/1003,30,tT)
 same => n,VoiceMail(1000@default,u)
 same => n,Hangup()

; Invalid
exten => i,1,Playback(invalid)
 same => n,Goto(ivr-main,s,1)

; ----------------------------------------
; WebRTC Context
; ----------------------------------------
[from-webrtc]
include => from-internal

; ----------------------------------------
; Voicemail Drop Context
; ----------------------------------------
[voicemail-drop]
exten => s,1,NoOp(Voicemail drop initiated)
 same => n,Answer()
 same => n,AMD()
 same => n,GotoIf($["${AMDSTATUS}" = "MACHINE"]?machine:human)
 same => n(machine),Wait(2)
 same => n,Playback(${VOICEMAIL_AUDIO})
 same => n,Hangup()
 same => n(human),Hangup()
