{% extends "accounts/base.html" %}
{% load account_filters %}

{% block title %}Account Kanban - SalesCompass{% endblock %}

{% block content %}
<h2 class="block-title fw-bold mb-0" >Account Health Kanban</h2>
<p class="text-muted">Drag accounts between columns to update their status.</p>

<div id="kanban-board" class="d-flex flex-wrap gap-3">
    <!-- Active Column -->
    <div class="kanban-column" data-status="active">
        <div class="card bg-light">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">✅ Active
                    <span class="badge bg-white text-success ms-2">{{ account|active_count }}</span>
                </h5>
            </div>
            <div class="card-body p-2" id="active-cards">
                {% for account in accounts %}
                    {% if account.status == 'active' %}
                        {% include "accounts/kanban_card.html" with account=account  status="active" %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- At Risk Column -->
    <div class="kanban-column" data-status="at_risk">
        <div class="card bg-light">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">⚠️ At Risk
                    <span class="badge bg-white text-warning ms-2">{{ at_risk_count|at_risk_count }}</span>
                </h5>
            </div>
            <div class="card-body p-2" id="at_risk-cards">
                {% for account in accounts %}
                    {% if account.status == 'at_risk' %}
                        {% include "accounts/kanban_card.html" with account=account %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Churned Column -->
    <div class="kanban-column" data-status="churned">
        <div class="card bg-light">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">❌ Churned
                    <span class="badge bg-white text-danger ms-2">{{ churned_count|churned_count }}</span>
                </h5>
            </div>
            <div class="card-body p-2" id="churned-cards">
                {% for account in accounts_index %}
                    {% if account.status == 'churned' %}
                        {% include "accounts/kanban_card.html" with account=account %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.kanban-column { min-width: 300px; flex: 1; }
.kanban-card { cursor: move; background: white; border-left: 4px solid #0d6efd; }
.kanban-card.dragging { opacity: 0.5; }
.health-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; color: white; }
.health-high { background-color: #198754; }
.health-medium { background-color: #ffc107; color: black; }
.health-low { background-color: #dc3545; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Make cards draggable
    const cards = document.querySelectorAll('.kanban-card');
    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });

    // Make columns droppable
    const columns = document.querySelectorAll('.kanban-column');
    columns.forEach(col => {
        col.addEventListener('dragover', handleDragOver);
        col.addEventListener('dragenter', handleDragEnter);
        col.addEventListener('dragleave', handleDragLeave);
        col.addEventListener('drop', handleDrop);
    });

    let draggedCard = null;

    function handleDragStart(e) {
        draggedCard = this;
        setTimeout(() => this.classList.add('dragging'), 0);
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd() {
        this.classList.remove('dragging');
        draggedCard = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        this.classList.add('bg-light');
    }

    function handleDragLeave() {
        this.classList.remove('bg-light');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('bg-light');
        
        if (draggedCard) {
            const cardContainer = this.querySelector('.card-body');
            cardContainer.appendChild(draggedCard);
            
            const targetStatus = this.dataset.status;
            const accountId = draggedCard.dataset.accountId;
            
            // Update status via AJAX
            updateAccountStatus(accountId, targetStatus);
        }
    }

    function updateAccountStatus(accountId, status) {
        fetch('{% url "accounts:update_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                account_id: accountId,
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Failed to update status: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Network error: ' + error);
        });
    }
});
</script>
{% endblock %}