
{% extends "accounts/base.html" %}
{% load static %}
{% block title %}Account Analytics - {{ block.super }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1 class="h3 mb-4">Account Analytics: {{ account.account_name }}</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Engagement Overview</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Engagement Score</h5>
                                    <p class="card-text display-4">{{ analytics_data.engagement_score|floatformat }}</p>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ analytics_data.engagement_score|floatformat }}%">
                                            {{ analytics_data.engagement_score|floatformat }}%
                                        </div>
                                    </div>
                                </div>
                            </health_score>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Health Score</h5>
                                    <p class="card-text display-4">{{ account.health_score|default:50|floatformat }}</p>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ account.health_score|default:50|floatformat }}%">
                                            {{ account.health_score|default:50|floatformat }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Revenue Potential</h5>
                                    <p class="card-text display-4">${{ analytics_data.revenue_analysis.total_pipeline_value|floatformat }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="h5 mb-3">Engagement Trend</h4>
                        <div class="chart-container">
                            <canvas id="engagementTrendChart" width="100%" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Account Summary</h2>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>Owner</strong>
                            <span>{{ account.owner.get_full_name|default:"Unassigned" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>Status</strong>
                            <span class="badge bg-{{ account.status|lower }} text-dark">
                                {{ account.status|title }}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>Contacts</strong>
                            <span>{{ account.contacts.count }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>Open Leads</strong>
                            <span>{{ analytics_data.lead_pipeline|dict_key:"count"|default:0 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>Open Opportunities</strong>
                            <span>{{ analytics_data.open_opportunities.count }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>Open Cases</strong>
                            <span>{{ analytics_data.case_history|length }}</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Recent Activity</h2>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for event in analytics_data.recent_engagement %}
                        <li class="list-group-item d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-{{ event.event_type|default:"activity" }} fs-4 text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="h6 mb-0">{{ event.title|default:event.get_event_type_display }}</h5>
                                <p class="small mb-0 text-muted">
                                    {{ event.created_at|date:"M j, Y" }}
                                </p>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-{{ event.event_type|default:"secondary" }}">
                                    {{ event.event_type|default:"activity"|title }}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Revenue Analysis</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Pipeline Value</h5>
                                    <p class="card-text display-6">${{ analytics_data.revenue_analysis.total_pipeline_value|floatformat }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Closed Revenue</h5>
                                    <p class="card-text display-6">${{ analytics_data.revenue_analysis.total_closed_value|floatformat }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="h6 mb-3">Historical Revenue</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Quarter</th>
                                    <th>Deal Count</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in analytics_data.revenue_analysis.historical_revenue %}
                                <tr>
                                    <td>{{ item.quarter }}</td>
                                    <td>{{ item.deal_count }}</td>
                                    <td>${{ item.value|floatformat }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Health History</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Score</th>
                                    <th>Engagement</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in analytics_data.health_history %}
                                <tr>
                                    <td>{{ item.date|date:"M j" }}</td>
                                    <td>{{ item.score|floatformat }}</td>
                                    <td>{{ item.engagement }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h2 class="h5 mb-0">Account Timeline</h2>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Account creation -->
                        <div class="timeline-item">
                            <div class="timeline-badge bg-primary"></div>
                            <div class="timeline-content">
                                <h5>Account Created</h5>
                                <p class="text-muted">{{ account.created_at|date:"F j, Y" }}</p>
                                <p>Created by {{ account.owner.email|default:"System" }}</p>
                            </div>
                        </div>
                        
                        <!-- Lead events -->
                        {% for lead in analytics_data.account_leads %}
                        <div class="timeline-item">
                            <div class="timeline-badge bg-success"></div>
                            <div class="timeline-content">
                                <h5>{{ lead.get_lead_source_display }} Lead</h5>
                                <p class="text-muted">{{ lead.created_at|date:"F j, Y" }}</p>
                                <p>{{ lead.first_name }} {{ lead.last_name }} - {{ lead.status|title }}</p>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Opportunity events -->
                        {% for opportunity in analytics_data.account_opportunities %}
                        <div class="timeline-item">
                            <div class="timeline-badge bg-warning"></div>
                            <div class="timeline-content">
                                <h5>Opportunity: {{ opportunity.name }}</h5>
                                <p class="text-muted">{{ opportunity.created_at|date:"F j, Y" }}</p>
                                <p>${{ opportunity.amount|floatformat }} - {{ opportunity.stage|title }}</p>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Engagement events -->
                        {% for event in analytics_data.recent_engagement %}
                        <div class="timeline-item">
                            <div class="timeline-badge bg-info"></div>
                            <div class="timeline-content">
                                <h5>{{ event.title|default:event.get_event_type_display }}</h5>
                                <p class="text-muted">{{ event.created_at|date:"F j, Y" }}</p>
                                <p>{{ event.engagement_event_description|truncatechars:50 }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script src="{% static 'js/charts.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Engagement trend chart
    const engagementCtx = document.getElementById('engagementTrendChart');
    if (engagementCtx) {
        const engagementData = {
            labels: [ {% for item in analytics_data.engagement_trend %}"{{ item.date }}",{% endfor %} ],
            datasets: [{
                label: 'Engagement',
                data: [ {% for item in analytics_data.engagement_trend %}{{ item.count }},{% endfor %} ],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                pointRadius: 0,
                pointHoverRadius: 3,
                tension: 0.4,
                fill: true
            }]
        };
        
        new Chart(engagementCtx, {
            type: 'line',
            data: engagementData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}